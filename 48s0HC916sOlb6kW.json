{"createdAt":"2025-09-01T14:36:59.509Z","updatedAt":"2025-11-07T18:56:06.000Z","id":"48s0HC916sOlb6kW","name":"Datamobil - Reader Web + An√°lise - Produ√ß√£o","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"1QQSmwbXjo0-jTDq2a0_TrhvPruhROeON","mode":"list","cachedResultName":"ReaderWeb.json","cachedResultUrl":"https://drive.google.com/file/d/1QQSmwbXjo0-jTDq2a0_TrhvPruhROeON/view?usp=drivesdk"},"options":{"binaryPropertyName":"json"}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[-2672,-16],"id":"449329df-841f-449f-8de6-ce12b73772ca","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"A7dItjE7OWcTVPSQ","name":"Google Drive account"}}},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"5f3b3c30-78e9-4ed0-b520-9153664540ec","leftValue":"={{ $json.query }}","rightValue":"SELECT","operator":{"type":"string","operation":"contains"}},{"id":"46b1dd62-2b29-409b-81ed-590c3703721f","leftValue":"={{ $json.query }}","rightValue":"Ol√°","operator":{"type":"string","operation":"notContains"}}],"combinator":"and"},"options":{}},"id":"a27d39c6-21ae-4112-98bf-2b69f3999375","name":"Check if query exists","type":"n8n-nodes-base.if","position":[-1424,-16],"typeVersion":2.2},{"parameters":{"assignments":{"assignments":[{"id":"ebbe194a-4b8b-44c9-ac19-03cf69d353bf","name":"query","type":"string","value":"={{ ($json.output) }}"}]},"includeOtherFields":true,"options":{}},"id":"eb657184-2698-4e45-a7ef-17ca53f8c8f2","name":"Extract SQL query","type":"n8n-nodes-base.set","position":[-1648,-16],"typeVersion":3.4},{"parameters":{"assignments":{"assignments":[{"id":"f78c57d9-df13-43c7-89a7-5387e528107e","name":"chatinput","type":"string","value":"={{ $('When chat message received').item.json.chatInput }}"},{"id":"e42b39eb-dfbd-48d9-94ed-d658bdd41454","name":"schema","type":"string","value":"={{ $json.json }}"}]},"options":{}},"id":"a2d68852-2113-4cdf-8378-a4355b49ab4d","name":"Combine schema data and chat input","type":"n8n-nodes-base.set","position":[-2224,-16],"executeOnce":true,"typeVersion":3.4},{"parameters":{"operation":"fromJson","binaryPropertyName":"json","destinationKey":"json","options":{"encoding":"utf8"}},"id":"04fb0465-3b26-4929-87d5-9982f4ed7688","name":"Extract data from file","type":"n8n-nodes-base.extractFromFile","position":[-2448,-16],"typeVersion":1},{"parameters":{"assignments":{"assignments":[{"id":"b86f4807-aff3-42fb-a110-f43653368396","name":"Solicitacao","value":"={{ $json.query.Solicitacao }}","type":"string"},{"id":"66447438-499c-4ab3-88ee-e20835aa7618","name":"CodigoIManager","value":"={{ $json.query.CodigoIManager }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3120,-16],"id":"9a44d9cb-1220-44ed-867e-4afaeb629023","name":"Setar informa√ß√µes de Par√¢metros"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f8f105fa-8e7c-4309-9cd9-9a5c987ed77f","leftValue":"={{ $json.allowed }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-976,-112],"id":"03e17d6e-a6e4-448b-83b5-f8316cedad3c","name":"If1"},{"parameters":{"jsCode":"// Run Once for All Items\n\nconst items = $input.all();\n\n// --- Utils ------------------------------------------------------------------\n\nfunction hasMeaningfulContent(o, depth = 0) {\n  if (o == null) return false;\n  if (typeof o !== 'object') return String(o).trim() !== '';\n  if (depth > 6) return true;\n  if (Array.isArray(o)) return o.some(v => hasMeaningfulContent(v, depth + 1));\n  const keys = Object.keys(o);\n  if (keys.length === 0) return false;\n  return keys.some(k => hasMeaningfulContent(o[k], depth + 1));\n}\n\nfunction collectErrorsDeep(obj, found = []) {\n  if (obj == null) return found;\n\n  const pushErr = (val) => {\n    if (val == null) return;\n    const msg = typeof val === 'object' ? JSON.stringify(val) : String(val);\n    if (msg.trim()) found.push(msg.trim());\n  };\n\n  if (Array.isArray(obj)) {\n    for (const v of obj) collectErrorsDeep(v, found);\n    return found;\n  }\n\n  if (typeof obj === 'object') {\n    for (const [k, v] of Object.entries(obj)) {\n      const lower = k.toLowerCase();\n      if (lower === 'erro' || lower === 'error') pushErr(v);\n      else if (lower === 'message' && typeof v === 'string') pushErr(v);\n      collectErrorsDeep(v, found);\n    }\n    return found;\n  }\n\n  return found;\n}\n\nfunction dedupStrings(arr) {\n  const seen = new Set();\n  const out = [];\n  for (const s of arr) if (!seen.has(s)) { seen.add(s); out.push(s); }\n  return out;\n}\n\n// Prefer√™ncia do Luis: $json.message.content.data\nfunction extractUsefulPayload(j) {\n  if (Array.isArray(j?.message?.content?.data)) return j.message.content.data.slice();\n  if (Array.isArray(j?.data)) return j.data.slice();\n  if (hasMeaningfulContent(j)) return [j];\n  return [];\n}\n\nfunction normalizeList(list) {\n  return list\n    .map(x => (x?.json ?? x))\n    .filter(o => hasMeaningfulContent(o))\n    .map(o => (typeof o === 'object' ? o : { value: o }));\n}\n\n// Captura a query de forma resiliente (suporta Set, Function e mesmo payload)\nfunction safeGetQuery() {\n  // 1) Se a query veio nos itens de entrada\n  for (const it of items) {\n    const j = it?.json ?? {};\n    const q = j.query ?? j.sql ?? j.consulta;\n    if (typeof q === 'string' && q.trim()) return q.trim();\n  }\n\n  // 2) Caso a query esteja em outro n√≥ do fluxo\n  try {\n    // Altere o nome abaixo para o n√≥ onde a SQL √© montada (ex: \"Extract SQL query\" ou \"Montar Query\")\n    const fromNode = $items('Extract SQL query', 0, 0);\n    for (const it of fromNode ?? []) {\n      const j = it?.json ?? {};\n      const q = j.query ?? j.sql ?? j.consulta;\n      if (typeof q === 'string' && q.trim()) return q.trim();\n    }\n  } catch (_) { /* ignora erros */ }\n\n  return null; // n√£o encontrada\n}\n\nfunction safeGetPedidoCliente() {\n  // 1) Se a query veio nos itens de entrada\n  for (const it of items) {\n    const j = it?.json ?? {};\n    const q = j.query ?? j.sql ?? j.consulta;\n    if (typeof q === 'string' && q.trim()) return q.trim();\n  }\n\n  // 2) Caso a query esteja em outro n√≥ do fluxo\n  try {\n    const fromNode = $('Combine schema data and chat input').first().json.chatinput\n    for (const it of fromNode ?? []) {\n      const j = it?.json ?? {};\n      const q = j.query ?? j.sql ?? j.consulta;\n      if (typeof q === 'string' && q.trim()) return q.trim();\n    }\n  } catch (_) { /* ignora erros */ }\n\n  return null; // n√£o encontrada\n}\n\n\n// --- Fluxo ------------------------------------------------------------------\n\n// 1) Sem entradas\nif (!items || items.length === 0) {\n  return [{ json: { Erro: 'N√£o foram encontrados dados para esta solicita√ß√£o' } }];\n}\n\n// 2) Procure erros em todo o payload bruto\nlet erros = [];\nfor (const it of items) {\n  const j = it?.json ?? {};\n  collectErrorsDeep(j, erros);\n}\nerros = dedupStrings(erros);\n\n// 3) Se achou erro, retorna somente { Erro }\nif (erros.length > 0) {\n  return [{ json: { Erro: erros[0] } }];\n}\n\n// 4) Extrair dados dos formatos suportados\nlet all = [];\nfor (const it of items) {\n  const j = it?.json ?? {};\n  all.push(...extractUsefulPayload(j));\n}\n\n// 5) Fallback: cada item.json\nif (all.length === 0) {\n  all = items.map(i => i?.json ?? {});\n}\n\n// 6) Checar erros dentro da lista\nlet innerErrors = [];\ncollectErrorsDeep(all, innerErrors);\ninnerErrors = dedupStrings(innerErrors);\nif (innerErrors.length > 0) {\n  return [{ json: { Erro: innerErrors[0] } }];\n}\n\n// 7) Limpeza de dados\nconst rows = normalizeList(all);\n\n// 8) Captura a query (sem quebrar se n√£o existir)\nconst query = safeGetQuery();\n\n// 9) Sem dados ‚Üí erro padr√£o\nif (rows.length === 0) {\n  return [{ json: { Erro: 'N√£o foram encontrados dados para esta solicita√ß√£o' } }];\n}\n\n// 10) OK: retorna SEMPRE { data, query }\nreturn [{ json: { data: rows, query } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-528,-16],"id":"039ca5bd-ff1f-4a03-9f02-ff98030a859e","name":"Repassar dados"},{"parameters":{"jsCode":"// Entrada: { sql: \"SELECT ...\", userPrompt: \"...\" }  (ajuste nomes se preciso)\nlet sql = ($('Extract SQL query').first().json.query || \"\").trim();\n\n// 1) Remove coment√°rios (-- e /* */) e normaliza espa√ßos\nconst stripComments = s => {\n  // remove /* ... */ (multilinha)\n  s = s.replace(/\\/\\*[\\s\\S]*?\\*\\//g, ' ');\n  // remove -- at√© o fim da linha\n  s = s.replace(/--.*$/gm, ' ');\n  return s;\n};\nconst cleaned = stripComments(sql).replace(/\\s+/g, ' ').trim();\n\nconst forbidden = /\\b(SOMENTE|INSERT|UPDATE|DELETE|MERGE|CREATE|ALTER|DROP|TRUNCATE|GRANT|REVOKE|COMMENT|VACUUM|COPY|REFRESH|CALL|DO|BEGIN|COMMIT|ROLLBACK|SET|LOCK|CLUSTER|REINDEX|DISCARD)\\b/i;\nif (forbidden.test(cleaned)) {\n  return [{ \n    allowed: false, \n    reason: \"Cont√©m comando proibido.\", \n    erro: `Somente SELECT √© permitido. N√£o posso executar DDL/DML.\n    Detalhes: ` + $input.first().json.output\n  }];\n}\n\nreturn [{ allowed: true, sql }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1200,-112],"id":"95d09280-0d68-40be-8e77-9c398291de2b","name":"Extrair query"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Run Once for Each Item\n// devolve UM item por entrada (sem colchetes)\nconst msg = $json.output; \nreturn {\n  json: {\n      erro:msg ?? \"Por favor, forne√ßa a consulta ou pergunta espec√≠fica que deseja realizar com base no esquema fornecido.\"\n  }\n};\n\n\n\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-752,176],"id":"e929fa12-fa86-4046-96af-562840faefc2","name":"Mensagem de query inv√°lida"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Run Once for Each Item\n/**\n const msg = \"Solicita√ß√£o cont√©m comando proibido, somente SELECT √© permitido. N√£o posso executar DDL/DML.\";\n */\nconst msg = $json.erro;\nreturn {\n  json: { erro: msg }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-752,-16],"id":"e8bb5448-b868-4c8e-a4f5-3f84b32340a5","name":"Mensagem de query Proibida"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $input.item;\nconst j = item.json;\n\nconst configuracaoPorCliente = {\n  \"0001\": {\n    host: \"readerweb.crn36nipjstz.us-east-1.rds.amazonaws.com\",\n    database: \"readerweb_0926_teste\",\n    user: \"root\",\n    senha: \"iF9Z!BE4gy\",\n    porta: 3306,\n  },\n  \"3738\": {\n    host: \"readerweb.crn36nipjstz.us-east-1.rds.amazonaws.com\",\n    database: \"readerweb_0926_teste\",\n    user: \"root\",\n    senha: \"iF9Z!BE4gy\",\n    porta: 3306,\n  },\n  \"0962\": {\n    host: \"teste1.imanager.inovamobil.com.br\",\n    database: \"readerweb_0962\",\n    user: \"teste\",\n    senha: \"teste.1234@\",\n    porta: 3306,\n  },\n};\n\n// ==== OBRIGAT√ìRIO TER c√≥digo do IManager ====\nconst codigoIManager = (j.CodigoIManager ?? \"0962\");\nconst selected = configuracaoPorCliente[codigoIManager];\nif (!selected) {\n  throw new Error(\n    `Cliente ` + codigoIManager + ` n√£o informado, favor validar para utiliza√ß√£o do m√≥dulo.`\n  );\n}\n\nj.configuracao = {\n    host: selected.host,\n    database: selected.database,\n    user: selected.user,\n    password: selected.senha,\n    port: selected.porta,\n  };\n\nreturn item;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2896,-16],"id":"10dff0e9-6967-41bf-b519-57e707e508c0","name":"Constantes"},{"parameters":{"operation":"executeQuery","query":"{{ $json.sql }}","options":{}},"id":"bccd3e43-0669-4800-91b0-5035034b73d9","name":"Executar query","type":"n8n-nodes-base.mySql","position":[-752,-208],"typeVersion":2.4,"alwaysOutputData":true,"credentials":{"mySql":{"id":"w2ul7xQhpE4d1ssF","name":"MySQL account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Captura o node \"Combine schema data and chat input\"\nconst combineNode = $('Combine schema data and chat input').first();\nconst pedido = combineNode?.json?.chatinput || '';\n\n// Captura o dataset atual\nconst src = $json.envelope ?? $json;\nconst dataIn = Array.isArray(src?.resultado?.data)\n  ? src.resultado.data\n  : Array.isArray(src?.data)\n  ? src.data\n  : [];\n\n// Normaliza chaves e converte valores num√©ricos\nconst normalizeKey = (k) =>\n  k\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/\\s+/g, '_')\n    .replace(/[^\\w]/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '')\n    .toLowerCase();\n\nconst toNumber = (v) =>\n  typeof v === 'string' && /^\\s*\\d+(?:[.,]\\d+)?\\s*$/.test(v)\n    ? Number(v.replace(',', '.'))\n    : v;\n\nconst dataNorm = (dataIn || []).map((row) => {\n  const out = {};\n  for (const [k, v] of Object.entries(row)) {\n    const nk = normalizeKey(k);\n    const nv = toNumber(v);\n    out[nk] = nv;\n    if (!(k in out)) out[k] = nv; // mant√©m original tamb√©m\n  }\n  return out;\n});\n\n// Monta o envelope final para o BILL\nreturn [\n  {\n    json: {\n      envelope: {\n        pedido_cliente: pedido || src.pedido_cliente || '‚Äî',\n        resultado: {\n          data: dataNorm,\n          query: src?.resultado?.query || src?.query || '',\n        },\n        metadados: src.metadados || {\n          origem: 'n8n',\n          unidade: 'clientes',\n          moeda: 'BRL',\n        },\n      },\n    },\n  },\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,176],"id":"35456242-c5a4-4444-bfb7-641b7fe148df","name":"Gerar envelope de dados e solicita√ß√£o"},{"parameters":{"jsCode":"// Agora o Merge j√° trouxe os dois lados num √∫nico item (json √∫nico)\nconst M = $json || {};\n\nconst pedido_cliente =$('Combine schema data and chat input').first().json.chatinput;\n  \nconst data =\n  M.data ??\n  M.envelope?.resultado?.data ??\n  null;\n\nconst query =\n  M.query ??\n  M.envelope?.resultado?.query ??\n  null;\n\n// Erros podem ter vindo de Repassar dados\nconst erro  = M.erro ?? M.error ?? null;\nconst erros = Array.isArray(M.Erros) ? M.Erros\n           : Array.isArray(M.erros) ? M.erros\n           : Array.isArray(M.errors) ? M.errors\n           : [];\n\n// A an√°lise pode ter vindo do Analista em v√°rias chaves\nconst diagnostico =$input.first().json[\"Diagn√≥stico\"];\n\nconst hasError = !!erro || (Array.isArray(erros) && erros.length > 0);\n\nreturn [{\n  json: {\n    pedido_cliente,\n    data,\n    query,\n    erro,\n    erros,\n    diagnostico: hasError ? null : diagnostico,\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,48],"id":"f9e5bb69-6886-4c20-b64a-2ad21ebd17ad","name":"Unificar Resultado"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"5787e004-2bc5-4530-8e20-cea5b52f05ef","leftValue":"={{ !!(\n  $json.Erro\n    ? (Array.isArray($json.Erro)\n        ? $json.Erro.length > 0\n        : String($json.Erro).trim() !== '')\n    : false\n) }}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-304,112],"id":"4f401b86-a15d-4404-a6c7-a18d1b8b4803","name":"Gerou algum erro ?"},{"parameters":{"promptType":"define","text":"=Here is the database schema: {{ $json.schema }}\nHere is the user request: {{ $json.chatinput }}","options":{"systemMessage":"Voc√™ √© um gerador de SQL para MySQL 8.0+, guiado por um JSON chamado SCHEMA.\nSeu objetivo √© gerar apenas consultas SELECT 100% v√°lidas e coerentes com o SCHEMA.\nNunca produza instru√ß√µes que criem, alterem, excluam ou modifiquem dados.\n\n‚öôÔ∏è CONFIGURA√á√ïES DE DIALETO E FORMATA√á√ÉO\n\nDialeto: MySQL 8.0+\n\nIdentificadores (tabelas e colunas): sempre entre crases ‚Üí `...`\n\nStrings: entre aspas simples ‚Üí 'texto'\n\nProibido:\n\nAspas duplas (\"...\")\n\nPrefixos de schema (ex.: public.)\n\nPonto e v√≠rgula (;) ao final da query\n\nCase: respeitar exatamente o case do SCHEMA\n\nSeparador decimal: ponto .\n\nPalavras reservadas s√≥ podem ser usadas se estiverem entre crases.\n\n\nüîí POL√çTICA DE SEGURAN√áA\nSomente SELECT √© permitido.\nN√£o posso criar, alterar, inserir ou deletar.\nReescreva seu pedido como um SELECT.\n\nComandos proibidos:\nINSERT, UPDATE, DELETE, MERGE, CREATE, ALTER, DROP, TRUNCATE,\nGRANT, REVOKE, COMMENT, VACUUM, COPY, REFRESH, CALL, DO, BEGIN,\nCOMMIT, ROLLBACK, SET, LOCK, CLUSTER, REINDEX, DISCARD.\n\n\nSe o usu√°rio pedir algo que envolva qualquer comando acima, responda somente com:\n\n‚ùå Somente SELECT √© permitido. N√£o posso criar, alterar, inserir ou deletar. Reescreva seu pedido como um SELECT.\n\n\n\nüß© REGRAS DE USO DO SCHEMA\n\nS√≥ use colunas e tabelas que existem no SCHEMA JSON.\n\nRespeite os tipos, nomes e cases definidos.\n\nSe o campo solicitado n√£o existir, responda:\n\n‚ùå N√£o √© poss√≠vel gerar a consulta porque o campo n√£o existe no SCHEMA.\n\n\nüîÅ USO DE METADADOS DO SCHEMA\n\nO SCHEMA JSON cont√©m informa√ß√µes adicionais sobre cada tabela e coluna, incluindo:\n\nPol√≠ticas de deduplica√ß√£o (meta.deduplication)\n\nRefer√™ncias mensais (meta.month_reference)\n\nEstrutura de pivot (meta.pivot)\n\nFun√ß√µes de coluna (meta.role)\n\nSempre que esses metadados estiverem presentes:\n\nAplique automaticamente as regras de deduplica√ß√£o:\nselecione apenas a linha mais recente por combina√ß√£o de campos definidos em partition_by (geralmente CodigoMatriculaCliente + MesAnoRefer√™ncia),\nusando ROW_NUMBER() e Sequencia DESC, sem usar agrega√ß√µes num√©ricas.\n\nQuando o pedido envolver duas ou mais refer√™ncias de m√™s/ano,\nuse as defini√ß√µes de meta.pivot para gerar um PIVOT:\n\n√≠ndice: pivot.index\n\ncolunas: pivot.columns\n\nvalores: os campos solicitados que existam em pivot.value_fields\n\nformato: long_format se nenhum campo solicitado estiver na lista.\n\nNunca use SUM, AVG ou COUNT para eliminar duplicatas; respeite allow_numeric_aggregation=false.\n\nUse as express√µes de data definidas em month_reference.to_date_expr para comparar ou ordenar per√≠odos.\n\nSe o SCHEMA informar \"meta_class\": \"analytical_view\",\ninterprete essa tabela como vis√£o de an√°lise temporal, aplicando as regras acima automaticamente.\n\nMySQL 8 N√ÉO possui PIVOT: nunca use a palavra-chave PIVOT/UNPIVOT. Emule o pivot criando uma CTE por refer√™ncia com ROW_NUMBER() (rn=1) e fa√ßa JOIN entre as CTEs por CodigoMatriculaCliente (ou LEFT+RIGHT+UNION quando precisar).‚Äù\n\n‚ÄúQuando 2+ refer√™ncias forem detectadas: pro√≠be SUM/AVG/COUNT/MAX/MIN e GROUP BY para deduplicar; use apenas janela + JOIN.‚Äù\n\n\nüß≠ SA√çDA EM PIVOT (obrigat√≥ria para 2+ refer√™ncias)\n- Se o pedido envolver `vhist√≥ricodeleitura` e forem detectadas 2+ refer√™ncias mensais:\n  ‚Ä¢ Gere PIVOT com √≠ndice `CodigoMatriculaCliente`, colunas `MesAnoRefer√™ncia`\n  ‚Ä¢ Use como valores APENAS os campos solicitados que existam em `meta.pivot.value_fields`\n  ‚Ä¢ Sem agrega√ß√£o num√©rica; deduplique com ROW_NUMBER() por cliente/m√™s (Sequencia DESC)\n- Nome das colunas do PIVOT: <Campo>_<MM>_<YYYY> (ex.: ConsumoFaturado_06_2022).\n- ‚úÖ CHECK DE CONFORMIDADE (obrigat√≥rio ‚Äî n√£o imprimir):\n  1) Existem pelo menos duas colunas cujo nome termina em _MM_YYYY?\n  2) Cada coluna de valor solicitada est√° replicada por m√™s? (ex.: ConsumoFaturado_06_2022 e ConsumoFaturado_07_2022)\n  3) A consulta cont√©m a deduplica√ß√£o por Sequencia (janela ou subconsulta)?\n  4) N√£o h√° SUM/AVG/COUNT para remover duplicidade.\nSe qualquer item falhar, regenere a consulta at√© atender aos quatro itens.\n\n\n\n\nüßÆ COMPORTAMENTO GERAL\n\nGere apenas SELECTs leg√≠veis e v√°lidos.\n\nO foco √© montar a query-base corretamente (sem regras de refer√™ncia ou coorte).\n\nN√£o precisa aplicar as travas avan√ßadas do modo anterior.\n\nPode usar agrega√ß√µes (SUM, AVG, COUNT, etc.) e WHERE, GROUP BY, ORDER BY, LIMIT.\n\nüîÅ REGRAS ESPEC√çFICAS PARA vhist√≥ricodeleitura\n\nQuando a consulta mencionar ‚Äúan√°lise‚Äù, ‚Äúcomparar‚Äù, ‚Äúrefer√™ncia‚Äù, ‚Äúm√™s‚Äù ou ‚Äúper√≠odo‚Äù, e envolver a tabela vhist√≥ricodeleitura,\nn√£o retorne linhas duplicadas por cliente e m√™s.\n\nNesse caso, retorne apenas uma linha por (CodigoMatriculaCliente, MesAnoRefer√™ncia).\n\nNunca utilize fun√ß√µes de soma (SUM, COUNT, AVG, etc.) para eliminar duplicidades.\n\nUse o campo Sequencia como crit√©rio: selecione a linha de maior Sequencia (ou a √∫ltima dispon√≠vel) para cada combina√ß√£o de cliente e refer√™ncia.\n\nA query deve conter:\n\ncl√°usula PARTITION BY CodigoMatriculaCliente, MesAnoRefer√™ncia\n\ne ROW_NUMBER() OVER (...) ou subconsulta equivalente,\n\nsem agrega√ß√µes matem√°ticas.\n\nExemplo de comportamento esperado:\n\nPedido: ‚ÄúAnalise os consumos de 06 e 07/2022.‚Äù\nGera√ß√£o correta: uma linha por cliente/m√™s, usando WHERE MesAnoRefer√™ncia IN ('06/2022','07/2022') e l√≥gica de deduplica√ß√£o via Sequencia.\n\n\nüì§ SA√çDA\n\nRetorne apenas o SQL final, sem explica√ß√µes, sem coment√°rios, e sem ponto e v√≠rgula no fim.","maxIterations":10,"returnIntermediateSteps":true}},"id":"8036a9bf-017d-45bc-8c5e-0618c8b99b35","name":"Gerador de Query","type":"@n8n/n8n-nodes-langchain.agent","position":[-2000,-16],"typeVersion":1.6},{"parameters":{"promptType":"define","text":"={\n  \"pedido_cliente\": \"{{$json.envelope.pedido_cliente}}\",\n  \"resultado\": {\n    \"data\": {{ JSON.stringify($json.envelope.resultado.data) }},\n    \"query\": \"{{$json.envelope.resultado.query}}\"\n  },\n  \"metadados\": {{ JSON.stringify($json.envelope.metadados) }}\n}","options":{"systemMessage":"‚¶É\nVoc√™ √© BILL, consultor t√©cnico e estrat√©gico especializado em saneamento b√°sico.\nSua miss√£o √© analisar o pedido_cliente e o resultado.data, produzindo um diagn√≥stico consultivo em JSON v√°lido, com rigor t√©cnico, sem texto fora do JSON.\nUse somente os dados de resultado.data para c√°lculos e an√°lise.\nN√£o presuma vari√°veis ausentes no dataset.\n\n‚¶É\n\"üéØ cen√°rio\": \"Contextualize o motivo do pedido, descrevendo a origem da demanda (operacional, comercial, ambiental ou institucional). Mostre o problema real a ser enfrentado e sua import√¢ncia estrat√©gica para a concession√°ria ou munic√≠pio. Explique o que est√° em jogo ‚Äî impacto na receita, qualidade do servi√ßo, regula√ß√£o ou imagem p√∫blica\",\n\n\"üß≠ contexto_setorial\": \"Compare o desempenho local com benchmarks nacionais, metas regulat√≥rias e boas pr√°ticas do setor. Utilize refer√™ncias de dados do SNIS 2023 (divulgados em 2025), ANA, Instituto Trata Brasil, ONDAS, ABCON/SINDCON, Instituto √Ågua e Saneamento e demais fontes oficiais. Mostre onde o cen√°rio analisado se destaca ou se distancia das m√©dias nacionais e de casos de sucesso.\",\n\n\"üìà indicadores\": ‚¶É\n\"üìù descri√ß√£o\": \"üìù descri√ß√£o\": \"Analise o dataset e reconhe√ßa automaticamente se ele est√° no formato de linha √∫nica com colunas agregadas (ex.: TotalClientes_09_2025, ConsumoMedio_09_2025) ou no formato de m√∫ltiplos registros. Quando houver colunas com valores num√©ricos mesmo em uma √∫nica linha, trate esses campos como indicadores quantitativos e utilize-os diretamente nos c√°lculos. Sempre que poss√≠vel, identifique e nomeie os campos com base em seus sufixos (ex.: '_MM_AAAA' indicando refer√™ncia temporal). Nunca conclua aus√™ncia de dados quantitativos se houver valores num√©ricos expl√≠citos, mesmo que o dataset tenha apenas uma linha. Quando houver linha √∫nica com colunas agregadas, trate essas colunas como indicadores num√©ricos principais (use o valor da coluna; n√£o conte linhas). Use tamb√©m as chaves normalizadas se presentes.\",\n\n\"üî¢ valores\": ‚¶É\n\"principais_m√©tricas\": \"Liste as m√©tricas calculadas ou identificadas automaticamente a partir dos nomes e valores das colunas. Por exemplo: total de registros, n√∫mero de ocorr√™ncias, consumo m√©dio, percentual de cobertura, varia√ß√£o entre per√≠odos etc.\",\n\"resumo_quantitativo\": \"Apresente os principais valores consolidados (somas, contagens, m√©dias, percentuais), com duas casas decimais. Se houver colunas com nomes de refer√™ncia temporal (ex.: _07_2025, _09_2025), identifique tend√™ncias e diferen√ßas entre per√≠odos.\",\n\"an√°lise_interpretativa\": \"Descreva de forma t√©cnica o que os valores significam ‚Äî se indicam melhora, piora, estabilidade, perda, ganho ou comportamento at√≠pico. Sempre que poss√≠vel, relacione com par√¢metros de desempenho setorial.\" ‚¶Ñ\n‚¶Ñ,\n\n\"üßæ descri√ß√£o\": \"Apresente um diagn√≥stico t√©cnico claro e objetivo, interpretando as poss√≠veis causas e efeitos dos resultados encontrados. Relacione os dados a pr√°ticas reais de campo, comportamento de consumo, opera√ß√£o de rede, controle de perdas ou atendimento. Destaque hip√≥teses plaus√≠veis, pontos de aten√ß√£o e oportunidades de valida√ß√£o.\",\n\n\"üß† estrat√©gias\": [\"Indique diretrizes de m√©dio prazo (3‚Äì12 meses) que ataquem a causa do problema identificado, priorizando efici√™ncia operacional, sustentabilidade financeira e conformidade regulat√≥ria. Inclua recomenda√ß√µes de integra√ß√£o tecnol√≥gica, revis√£o de processos ou amplia√ß√£o de programas.\"],\n\n\"‚öôÔ∏è a√ß√µes\": [\"Descreva medidas curtas e espec√≠ficas (‚â§30 dias), apontando respons√°veis, prioridade e resultado esperado. Inclua auditorias, ajustes sist√™micos, revis√µes de cadastro, inspe√ß√µes em campo ou comunica√ß√£o direta com usu√°rios.\"],\n\n\"‚ö†Ô∏è riscos_e_oportunidades\": ‚¶É\n\"‚õî riscos\": [\"Liste amea√ßas reais observadas a partir dos dados, como perdas comerciais, riscos de autua√ß√£o regulat√≥ria, insatisfa√ß√£o do usu√°rio, falhas de medi√ß√£o, erros de leitura ou inconsist√™ncias operacionais.\"],\n\"‚úÖ oportunidades\": [\"Evidencie ganhos concretos poss√≠veis ‚Äî como aumento de receita, melhoria da confiabilidade dos dados, redu√ß√£o de reclama√ß√µes, fortalecimento institucional e aprimoramento da imagem junto √† sociedade e ao regulador.\"]\n‚¶Ñ,\n\n\"üß© decis√µes_futuras\": [\"Formule quest√µes estrat√©gicas que orientar√£o a pr√≥xima etapa de an√°lise ou decis√£o, como: 'Qual o impacto financeiro da corre√ß√£o?', 'Quais investimentos s√£o priorit√°rios?', 'H√° sinergia com outros programas ou metas da ag√™ncia reguladora?'.\"],\n\n\"üß∑ resumo_consultivo\": \"Elabore uma conclus√£o executiva e assertiva (m√°x. 10 linhas) integrando o cen√°rio, as evid√™ncias encontradas e as recomenda√ß√µes priorit√°rias. Destaque o valor estrat√©gico do achado e o benef√≠cio direto de agir sobre ele ‚Äî para o equil√≠brio econ√¥mico, a efici√™ncia operacional e a sustentabilidade do saneamento.\"\n‚¶Ñ\n\nFontes oficiais de apoio:\n\nANA ‚Äì Ag√™ncia Nacional de √Åguas e Saneamento B√°sico\n\nSNIS ‚Äì Sistema Nacional de Informa√ß√µes sobre Saneamento (ano-base 2023, divulgado em 2025)\n\nInstituto Trata Brasil\n\nONDAS ‚Äì Observat√≥rio Nacional dos Direitos √† √Ågua e ao Saneamento\n\nABCON/SINDCON, CBIC Infraestrutura\n\nSabesp, Copasa, Aegea, Rio+Saneamento\n\nAg√™ncias reguladoras: ARSESP, ADASA, AGEMS, ARISB, AGEREG etc.\n\nPlataforma ‚ÄúMunic√≠pios e Saneamento‚Äù ‚Äì Instituto √Ågua e Saneamento (dados para os 5.570 munic√≠pios brasileiros) \nIAS - Instituto √Ågua e Saneamento\n+1\n\nExplore & Compare ‚Äì Plataforma ‚ÄúMunic√≠pios e Saneamento‚Äù (m√≥dulo comparativo) \nIAS - Instituto √Ågua e Saneamento\n+1\n\nRegras adicionais:\n\nDetecte o tema do pedido (ex: leitura, consumo, perdas, qualidade, regula√ß√£o) e adapte.\n\nUtilize apenas colunas presentes no dataset para calcular indicadores, percentuais e correla√ß√µes.\n\nN√£o adicione campos ou suposi√ß√µes n√£o suportadas pelos dados.\n\nSempre cite ano-base ao referenciar dados de benchmark ou relat√≥rio.\n\nFale com autoridade t√©cnica e institucional.\n\nN√£o produza texto fora do JSON.\n‚¶Ñ","maxIterations":10,"returnIntermediateSteps":true}},"id":"dc67cd37-dfbb-47e6-80da-75b55d363cf3","name":"Analista de Dados","type":"@n8n/n8n-nodes-langchain.agent","position":[144,112],"typeVersion":1.6,"onError":"continueRegularOutput"},{"parameters":{"model":"gpt-4.1-mini","options":{"maxTokens":1024,"temperature":0.2}},"id":"f7a5864e-770b-4346-a3b5-89585601e6eb","name":"OpenAI Chat Model gerador de Query","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[-2000,208],"typeVersion":1,"credentials":{"openAiApi":{"id":"H4HnbIJCN7JE8cR5","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"04225153"},"id":"6d2a647a-9f8b-4351-86fc-a8ecbcbbc1bd","name":"Window Buffer Memory Analista de dados","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","position":[288,336],"typeVersion":1.2},{"parameters":{"model":"gpt-4.1-mini","options":{"maxTokens":1024,"temperature":0.2,"maxRetries":1}},"id":"ad1bed0e-0359-4a50-b5ae-e74d4ba2795e","name":"OpenAI Chat Model Analista de dados","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[144,304],"typeVersion":1,"credentials":{"openAiApi":{"id":"H4HnbIJCN7JE8cR5","name":"OpenAi account"}}},{"parameters":{"contextWindowLength":10},"id":"92509306-8e2c-4b9b-85de-daeaffe92145","name":"Mem√≥ria gerador de query","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","position":[-1856,208],"typeVersion":1.2},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[672,-64],"id":"cfd2c79a-f8a0-4c57-81ac-f967f386de88","name":"Unificar saidas"},{"parameters":{"assignments":{"assignments":[{"id":"c3123cce-0fd1-4e46-9107-a78437776d9c","name":"Saida","value":"={{ \"üìä Resultado da an√°lise:\\n\\n\" + JSON.stringify($json, null, 2) }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1520,256],"id":"fb3ac015-b5f7-48d2-9a27-1ea5248ed031","name":"Apresentar Dados"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5787e004-2bc5-4530-8e20-cea5b52f05ef","leftValue":"={{ $json.Erro.length }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[864,-64],"id":"de07ec64-29f3-43a1-989e-9e6fa8f3c3e0","name":"Gerou algum erro ?1"},{"parameters":{"options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1104,-240],"id":"61889611-6081-4d92-af92-3b1bfcb583f5","name":"Respond to Webhook1"},{"parameters":{"jsCode":"// === capta√ß√£o do bruto (igual antes) ===\nconst steps = $json.intermediateSteps ?? [];\nlet raw =\n  (steps.length ? (steps[steps.length - 1].output ?? steps[steps.length - 1].toolOutput ?? steps[steps.length - 1].result) : null)\n  ?? $json.output ?? $json.text ?? $json.response ?? \"\";\n\nif (raw && typeof raw === \"object\") {\n  var obj = raw;\n} else {\n  raw = String(raw).trim()\n    .replace(/^```(?:json)?\\s*/i, \"\").replace(/\\s*```$/i, \"\");\n  if ((raw.startsWith('\"') && raw.endsWith('\"')) || (raw.startsWith(\"'\") && raw.endsWith(\"'\"))) {\n    try { raw = JSON.parse(raw); } catch {}\n  }\n  if (typeof raw === \"string\") {\n    const m = raw.match(/\\{[\\s\\S]*\\}/m);\n    if (m) raw = m[0];\n  }\n  try { var obj = (typeof raw === \"string\") ? JSON.parse(raw) : raw; }\n  catch (e) {\n    return [{ json: { Diagn√≥stico: { erro: \"Falha ao parsear JSON do Agent\", detalhe: String(e), amostra: String(raw).slice(0, 500) } } }];\n  }\n}\n\n// === renomea√ß√£o para chaves com emoji ===\nconst map = {\n  \"cen√°rio\": \"üéØ cen√°rio\",\n  \"contexto_setorial\": \"üß≠ contexto_setorial\",\n  \"indicadores\": \"üìà indicadores\",\n  \"descricao\": \"üìù descri√ß√£o\",\n  \"valores\": \"üî¢ valores\",\n  \"estrategias\": \"üß† estrat√©gias\",\n  \"acoes\": \"‚öôÔ∏è a√ß√µes\",\n  \"riscos_e_oportunidades\": \"‚ö†Ô∏è riscos_e_oportunidades\",\n  \"riscos\": \"‚õî riscos\",\n  \"oportunidades\": \"‚úÖ oportunidades\",\n  \"decisos_futuras\": \"üß© decis√µes_futuras\", // prote√ß√£o caso venha com typo\n  \"decisoes_futuras\": \"üß© decis√µes_futuras\",\n  \"resumo_consultivo\": \"üß∑ resumo_consultivo\"\n};\n\n// fun√ß√£o que renomeia chaves no n√≠vel 1 e nos blocos internos conhecidos\nfunction renameKeys(o) {\n  if (o == null || typeof o !== \"object\") return o;\n  const out = {};\n  for (const [k, v] of Object.entries(o)) {\n    const nk = map[k] ?? k;\n    out[nk] = v;\n  }\n  // tratar blocos internos\n  if (out[\"üìà indicadores\"] && typeof out[\"üìà indicadores\"] === \"object\") {\n    const ind = out[\"üìà indicadores\"];\n    const indOut = {};\n    for (const [k, v] of Object.entries(ind)) {\n      const nk = map[k] ?? k;\n      indOut[nk] = v;\n    }\n    out[\"üìà indicadores\"] = indOut;\n  }\n  if (out[\"‚ö†Ô∏è riscos_e_oportunidades\"] && typeof out[\"‚ö†Ô∏è riscos_e_oportunidades\"] === \"object\") {\n    const ro = out[\"‚ö†Ô∏è riscos_e_oportunidades\"];\n    const roOut = {};\n    for (const [k, v] of Object.entries(ro)) {\n      const nk = map[k] ?? k;\n      roOut[nk] = v;\n    }\n    out[\"‚ö†Ô∏è riscos_e_oportunidades\"] = roOut;\n  }\n  return out;\n}\n\nconst withEmoji = renameKeys(obj);\n\n// === encapsula em Diagn√≥stico ===\nreturn [{ json: { Diagn√≥stico: withEmoji } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[480,128],"id":"5224de56-763e-4279-b199-9e5945ea5a58","name":"Formatar retorno GPT"},{"parameters":{"public":true,"initialMessages":"Em que posso lhe ajudar hoje ???","options":{"subtitle":"Transformando linguagem de neg√≥cio em dados ‚úÖ","title":"Boa tarde !!! Sou o Datamobil üìà"}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[-3456,0],"id":"d6ca1c79-329f-491e-816f-e9a2e30b9979","name":"When chat message received","webhookId":"d90fd405-b2e9-487b-b316-61bce6f6b61f"}],"connections":{"Download file":{"main":[[{"node":"Extract data from file","type":"main","index":0}]]},"Check if query exists":{"main":[[{"node":"Extrair query","type":"main","index":0}],[{"node":"Mensagem de query inv√°lida","type":"main","index":0}]]},"Extract SQL query":{"main":[[{"node":"Check if query exists","type":"main","index":0}]]},"Combine schema data and chat input":{"main":[[{"node":"Gerador de Query","type":"main","index":0}]]},"Extract data from file":{"main":[[{"node":"Combine schema data and chat input","type":"main","index":0}]]},"Setar informa√ß√µes de Par√¢metros":{"main":[[{"node":"Constantes","type":"main","index":0}]]},"If1":{"main":[[{"node":"Executar query","type":"main","index":0}],[{"node":"Mensagem de query Proibida","type":"main","index":0}]]},"Repassar dados":{"main":[[{"node":"Gerou algum erro ?","type":"main","index":0},{"node":"Unificar saidas","type":"main","index":0}]]},"Extrair query":{"main":[[{"node":"If1","type":"main","index":0}]]},"Mensagem de query inv√°lida":{"main":[[{"node":"Repassar dados","type":"main","index":0}]]},"Mensagem de query Proibida":{"main":[[{"node":"Repassar dados","type":"main","index":0}]]},"Constantes":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Executar query":{"main":[[{"node":"Repassar dados","type":"main","index":0}]]},"Gerar envelope de dados e solicita√ß√£o":{"main":[[{"node":"Analista de Dados","type":"main","index":0}]]},"Unificar Resultado":{"main":[[]]},"Gerou algum erro ?":{"main":[[{"node":"Unificar saidas","type":"main","index":1}],[{"node":"Gerar envelope de dados e solicita√ß√£o","type":"main","index":0}]]},"Gerador de Query":{"main":[[{"node":"Extract SQL query","type":"main","index":0}]]},"Analista de Dados":{"main":[[{"node":"Formatar retorno GPT","type":"main","index":0}]]},"OpenAI Chat Model gerador de Query":{"ai_languageModel":[[{"node":"Gerador de Query","type":"ai_languageModel","index":0}]]},"Window Buffer Memory Analista de dados":{"ai_memory":[[{"node":"Analista de Dados","type":"ai_memory","index":0}]]},"OpenAI Chat Model Analista de dados":{"ai_languageModel":[[{"node":"Analista de Dados","type":"ai_languageModel","index":0}]]},"Mem√≥ria gerador de query":{"ai_memory":[[{"node":"Gerador de Query","type":"ai_memory","index":0}]]},"Unificar saidas":{"main":[[{"node":"Gerou algum erro ?1","type":"main","index":0}]]},"Gerou algum erro ?1":{"main":[[{"node":"Respond to Webhook1","type":"main","index":0}],[{"node":"Unificar Resultado","type":"main","index":0}]]},"Formatar retorno GPT":{"main":[[{"node":"Unificar saidas","type":"main","index":1}]]},"When chat message received":{"main":[[{"node":"Setar informa√ß√µes de Par√¢metros","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"c10f9300-6b4e-4b79-847c-1f0a694a2fb9","triggerCount":1,"shared":[{"createdAt":"2025-09-01T14:36:59.523Z","updatedAt":"2025-09-01T14:36:59.523Z","role":"workflow:owner","workflowId":"48s0HC916sOlb6kW","projectId":"bDUBly1zU3yziLIn"}],"tags":[]}