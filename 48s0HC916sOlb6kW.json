{"createdAt":"2025-09-01T14:36:59.509Z","updatedAt":"2025-11-08T21:55:11.000Z","id":"48s0HC916sOlb6kW","name":"Datamobil - Reader Web + AnÃ¡lise - ProduÃ§Ã£o","active":true,"isArchived":false,"nodes":[{"parameters":{"operation":"download","fileId":{"__rl":true,"value":"1QQSmwbXjo0-jTDq2a0_TrhvPruhROeON","mode":"list","cachedResultName":"ReaderWeb.json","cachedResultUrl":"https://drive.google.com/file/d/1QQSmwbXjo0-jTDq2a0_TrhvPruhROeON/view?usp=drivesdk"},"options":{"binaryPropertyName":"json"}},"type":"n8n-nodes-base.googleDrive","typeVersion":3,"position":[-2672,-16],"id":"449329df-841f-449f-8de6-ce12b73772ca","name":"Download file","credentials":{"googleDriveOAuth2Api":{"id":"A7dItjE7OWcTVPSQ","name":"Google Drive account"}}},{"parameters":{"conditions":{"options":{"version":2,"leftValue":"","caseSensitive":true,"typeValidation":"strict"},"conditions":[{"id":"5f3b3c30-78e9-4ed0-b520-9153664540ec","leftValue":"={{ $json.query }}","rightValue":"SELECT","operator":{"type":"string","operation":"contains"}},{"id":"46b1dd62-2b29-409b-81ed-590c3703721f","leftValue":"={{ $json.query }}","rightValue":"OlÃ¡","operator":{"type":"string","operation":"notContains"}}],"combinator":"and"},"options":{}},"id":"a27d39c6-21ae-4112-98bf-2b69f3999375","name":"Check if query exists","type":"n8n-nodes-base.if","position":[-1424,-16],"typeVersion":2.2},{"parameters":{"assignments":{"assignments":[{"id":"ebbe194a-4b8b-44c9-ac19-03cf69d353bf","name":"query","type":"string","value":"={{ ($json.output) }}"}]},"includeOtherFields":true,"options":{}},"id":"eb657184-2698-4e45-a7ef-17ca53f8c8f2","name":"Extract SQL query","type":"n8n-nodes-base.set","position":[-1648,-16],"typeVersion":3.4},{"parameters":{"assignments":{"assignments":[{"id":"f78c57d9-df13-43c7-89a7-5387e528107e","name":"chatinput","type":"string","value":"={{ $('When chat message received').item.json.chatInput }}"},{"id":"e42b39eb-dfbd-48d9-94ed-d658bdd41454","name":"schema","type":"string","value":"={{ $json.json }}"}]},"options":{}},"id":"a2d68852-2113-4cdf-8378-a4355b49ab4d","name":"Combine schema data and chat input","type":"n8n-nodes-base.set","position":[-2224,-16],"executeOnce":true,"typeVersion":3.4},{"parameters":{"operation":"fromJson","binaryPropertyName":"json","destinationKey":"json","options":{"encoding":"utf8"}},"id":"04fb0465-3b26-4929-87d5-9982f4ed7688","name":"Extract data from file","type":"n8n-nodes-base.extractFromFile","position":[-2448,-16],"typeVersion":1},{"parameters":{"assignments":{"assignments":[{"id":"b86f4807-aff3-42fb-a110-f43653368396","name":"Solicitacao","value":"={{ $json.query.Solicitacao }}","type":"string"},{"id":"66447438-499c-4ab3-88ee-e20835aa7618","name":"CodigoIManager","value":"={{ $json.query.CodigoIManager }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3120,-16],"id":"9a44d9cb-1220-44ed-867e-4afaeb629023","name":"Setar informaÃ§Ãµes de ParÃ¢metros"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"f8f105fa-8e7c-4309-9cd9-9a5c987ed77f","leftValue":"={{ $json.allowed }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-976,-112],"id":"03e17d6e-a6e4-448b-83b5-f8316cedad3c","name":"If1"},{"parameters":{"jsCode":"// Run Once for All Items\n\nconst items = $input.all();\n\n// --- Utils ------------------------------------------------------------------\n\nfunction hasMeaningfulContent(o, depth = 0) {\n  if (o == null) return false;\n  if (typeof o !== 'object') return String(o).trim() !== '';\n  if (depth > 6) return true;\n  if (Array.isArray(o)) return o.some(v => hasMeaningfulContent(v, depth + 1));\n  const keys = Object.keys(o);\n  if (keys.length === 0) return false;\n  return keys.some(k => hasMeaningfulContent(o[k], depth + 1));\n}\n\nfunction collectErrorsDeep(obj, found = []) {\n  if (obj == null) return found;\n\n  const pushErr = (val) => {\n    if (val == null) return;\n    const msg = typeof val === 'object' ? JSON.stringify(val) : String(val);\n    if (msg.trim()) found.push(msg.trim());\n  };\n\n  if (Array.isArray(obj)) {\n    for (const v of obj) collectErrorsDeep(v, found);\n    return found;\n  }\n\n  if (typeof obj === 'object') {\n    for (const [k, v] of Object.entries(obj)) {\n      const lower = k.toLowerCase();\n      if (lower === 'erro' || lower === 'error') pushErr(v);\n      else if (lower === 'message' && typeof v === 'string') pushErr(v);\n      collectErrorsDeep(v, found);\n    }\n    return found;\n  }\n\n  return found;\n}\n\nfunction dedupStrings(arr) {\n  const seen = new Set();\n  const out = [];\n  for (const s of arr) if (!seen.has(s)) { seen.add(s); out.push(s); }\n  return out;\n}\n\n// PreferÃªncia do Luis: $json.message.content.data\nfunction extractUsefulPayload(j) {\n  if (Array.isArray(j?.message?.content?.data)) return j.message.content.data.slice();\n  if (Array.isArray(j?.data)) return j.data.slice();\n\n  // >>> AJUSTE 1: ignorar payload que Ã© sÃ³ { success: true }\n  if (j && typeof j === 'object') {\n    const keys = Object.keys(j);\n    if (keys.length === 1 && keys[0] === 'success') {\n      return [];\n    }\n  }\n\n  if (hasMeaningfulContent(j)) return [j];\n  return [];\n}\n\nfunction normalizeList(list) {\n  return list\n    .map(x => (x?.json ?? x))\n    .filter(o => hasMeaningfulContent(o))\n    .map(o => (typeof o === 'object' ? o : { value: o }));\n}\n\n// Captura a query de forma resiliente (suporta Set, Function e mesmo payload)\nfunction safeGetQuery() {\n  // 1) Se a query veio nos itens de entrada\n  for (const it of items) {\n    const j = it?.json ?? {};\n    const q = j.query ?? j.sql ?? j.consulta;\n    if (typeof q === 'string' && q.trim()) return q.trim();\n  }\n\n  // 2) Caso a query esteja em outro nÃ³ do fluxo\n  try {\n    // Altere o nome abaixo para o nÃ³ onde a SQL Ã© montada (ex: \"Extract SQL query\" ou \"Montar Query\")\n    const fromNode = $items('Extract SQL query', 0, 0);\n    for (const it of fromNode ?? []) {\n      const j = it?.json ?? {};\n      const q = j.query ?? j.sql ?? j.consulta;\n      if (typeof q === 'string' && q.trim()) return q.trim();\n    }\n  } catch (_) { /* ignora erros */ }\n\n  return null; // nÃ£o encontrada\n}\n\nfunction safeGetPedidoCliente() {\n  for (const it of items) {\n    const j = it?.json ?? {};\n    const q = j.query ?? j.sql ?? j.consulta;\n    if (typeof q === 'string' && q.trim()) return q.trim();\n  }\n\n  try {\n    const fromNode = $('Combine schema data and chat input').first().json.chatinput;\n    for (const it of fromNode ?? []) {\n      const j = it?.json ?? {};\n      const q = j.query ?? j.sql ?? j.consulta;\n      if (typeof q === 'string' && q.trim()) return q.trim();\n    }\n  } catch (_) { /* ignora erros */ }\n\n  return null; // nÃ£o encontrada\n}\n\n\n// --- Fluxo ------------------------------------------------------------------\n\n// 1) Sem entradas\nif (!items || items.length === 0) {\n  return [{ json: { Erro: 'NÃ£o foram encontrados dados para esta solicitaÃ§Ã£o' } }];\n}\n\n// 2) Procure erros em todo o payload bruto\nlet erros = [];\nfor (const it of items) {\n  const j = it?.json ?? {};\n  collectErrorsDeep(j, erros);\n}\nerros = dedupStrings(erros);\n\n// 3) Se achou erro, retorna somente { Erro }\nif (erros.length > 0) {\n  return [{ json: { Erro: erros[0] } }];\n}\n\n// 4) Extrair dados dos formatos suportados\nlet all = [];\nfor (const it of items) {\n  const j = it?.json ?? {};\n  all.push(...extractUsefulPayload(j));\n}\n\n// 5) Fallback: cada item.json\nif (all.length === 0) {\n  all = items.map(i => i?.json ?? {});\n}\n\n// 6) Checar erros dentro da lista\nlet innerErrors = [];\ncollectErrorsDeep(all, innerErrors);\ninnerErrors = dedupStrings(innerErrors);\nif (innerErrors.length > 0) {\n  return [{ json: { Erro: innerErrors[0] } }];\n}\n\n// 7) Limpeza de dados\nconst rows = normalizeList(all);\n\n// 8) Captura a query (sem quebrar se nÃ£o existir)\nconst query = safeGetQuery();\n\n// 9) Sem dados OU apenas um marcador de sucesso â†’ erro padrÃ£o\n// >>> AJUSTE 2: tratar { success: true } como \"sem dados\"\nconst isOnlySuccess =\n  rows.length === 1 &&\n  rows[0] &&\n  typeof rows[0] === 'object' &&\n  Object.keys(rows[0]).length === 1 &&\n  Object.prototype.hasOwnProperty.call(rows[0], 'success');\n\nif (rows.length === 0 || isOnlySuccess) {\n  return [{ json: { Erro: 'NÃ£o foram encontrados dados para esta solicitaÃ§Ã£o' } }];\n}\n\n// 10) OK: retorna SEMPRE { data, query }\nreturn [{ json: { data: rows, query } }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-528,-16],"id":"039ca5bd-ff1f-4a03-9f02-ff98030a859e","name":"Repassar dados"},{"parameters":{"jsCode":"// Entrada: { sql: \"SELECT ...\", userPrompt: \"...\" }  (ajuste nomes se preciso)\nlet sql = ($('Extract SQL query').first().json.query || \"\").trim();\n\n// 1) Remove comentÃ¡rios (-- e /* */) e normaliza espaÃ§os\nconst stripComments = s => {\n  // remove /* ... */ (multilinha)\n  s = s.replace(/\\/\\*[\\s\\S]*?\\*\\//g, ' ');\n  // remove -- atÃ© o fim da linha\n  s = s.replace(/--.*$/gm, ' ');\n  return s;\n};\nconst cleaned = stripComments(sql).replace(/\\s+/g, ' ').trim();\n\nconst forbidden = /\\b(SOMENTE|INSERT|UPDATE|DELETE|MERGE|CREATE|ALTER|DROP|TRUNCATE|GRANT|REVOKE|COMMENT|VACUUM|COPY|REFRESH|CALL|DO|BEGIN|COMMIT|ROLLBACK|SET|LOCK|CLUSTER|REINDEX|DISCARD)\\b/i;\nif (forbidden.test(cleaned)) {\n  return [{ \n    allowed: false, \n    reason: \"ContÃ©m comando proibido.\", \n    erro: `Somente SELECT Ã© permitido. NÃ£o posso executar DDL/DML.\n    Detalhes: ` + $input.first().json.output\n  }];\n}\n\nreturn [{ allowed: true, sql }];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1200,-112],"id":"95d09280-0d68-40be-8e77-9c398291de2b","name":"Extrair query"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Run Once for Each Item\n// devolve UM item por entrada (sem colchetes)\nconst msg = $json.output; \nreturn {\n  json: {\n      erro:msg ?? \"Por favor, forneÃ§a a consulta ou pergunta especÃ­fica que deseja realizar com base no esquema fornecido.\"\n  }\n};\n\n\n\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-752,176],"id":"e929fa12-fa86-4046-96af-562840faefc2","name":"Mensagem de query invÃ¡lida"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Run Once for Each Item\n/**\n const msg = \"SolicitaÃ§Ã£o contÃ©m comando proibido, somente SELECT Ã© permitido. NÃ£o posso executar DDL/DML.\";\n */\nconst msg = $json.erro;\nreturn {\n  json: { erro: msg }\n};\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-752,-16],"id":"e8bb5448-b868-4c8e-a4f5-3f84b32340a5","name":"Mensagem de query Proibida"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const item = $input.item;\nconst j = item.json;\n\nconst configuracaoPorCliente = {\n  \"0001\": {\n    host: \"readerweb.crn36nipjstz.us-east-1.rds.amazonaws.com\",\n    database: \"readerweb_0926_teste\",\n    user: \"root\",\n    senha: \"iF9Z!BE4gy\",\n    porta: 3306,\n  },\n  \"3738\": {\n    host: \"readerweb.crn36nipjstz.us-east-1.rds.amazonaws.com\",\n    database: \"readerweb_0926_teste\",\n    user: \"root\",\n    senha: \"iF9Z!BE4gy\",\n    porta: 3306,\n  },\n  \"0962\": {\n    host: \"teste1.imanager.inovamobil.com.br\",\n    database: \"readerweb_0962\",\n    user: \"teste\",\n    senha: \"teste.1234@\",\n    porta: 3306,\n  },\n};\n\n// ==== OBRIGATÃ“RIO TER cÃ³digo do IManager ====\nconst codigoIManager = (j.CodigoIManager ?? \"0962\");\nconst selected = configuracaoPorCliente[codigoIManager];\nif (!selected) {\n  throw new Error(\n    `Cliente ` + codigoIManager + ` nÃ£o informado, favor validar para utilizaÃ§Ã£o do mÃ³dulo.`\n  );\n}\n\nj.configuracao = {\n    host: selected.host,\n    database: selected.database,\n    user: selected.user,\n    password: selected.senha,\n    port: selected.porta,\n  };\n\nreturn item;\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-2896,-16],"id":"10dff0e9-6967-41bf-b519-57e707e508c0","name":"Constantes"},{"parameters":{"operation":"executeQuery","query":"{{ $json.sql }}","options":{}},"id":"bccd3e43-0669-4800-91b0-5035034b73d9","name":"Executar query","type":"n8n-nodes-base.mySql","position":[-752,-208],"typeVersion":2.4,"alwaysOutputData":true,"credentials":{"mySql":{"id":"w2ul7xQhpE4d1ssF","name":"MySQL account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Captura o node \"Combine schema data and chat input\"\nconst combineNode = $('Combine schema data and chat input').first();\nconst pedido = combineNode?.json?.chatinput || '';\n\n// Captura o dataset atual\nconst src = $json.envelope ?? $json;\nconst dataIn = Array.isArray(src?.resultado?.data)\n  ? src.resultado.data\n  : Array.isArray(src?.data)\n  ? src.data\n  : [];\n\n// Normaliza chaves e converte valores numÃ©ricos\nconst normalizeKey = (k) =>\n  k\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/\\s+/g, '_')\n    .replace(/[^\\w]/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '')\n    .toLowerCase();\n\nconst toNumber = (v) =>\n  typeof v === 'string' && /^\\s*\\d+(?:[.,]\\d+)?\\s*$/.test(v)\n    ? Number(v.replace(',', '.'))\n    : v;\n\nconst dataNorm = (dataIn || []).map((row) => {\n  const out = {};\n  for (const [k, v] of Object.entries(row)) {\n    const nk = normalizeKey(k);\n    const nv = toNumber(v);\n    out[nk] = nv;\n    if (!(k in out)) out[k] = nv; // mantÃ©m original tambÃ©m\n  }\n  return out;\n});\n\n// Monta o envelope final para o BILL\nreturn [\n  {\n    json: {\n      envelope: {\n        pedido_cliente: pedido || src.pedido_cliente || 'â€”',\n        resultado: {\n          data: dataNorm,\n          query: src?.resultado?.query || src?.query || '',\n        },\n        metadados: src.metadados || {\n          origem: 'n8n',\n          unidade: 'clientes',\n          moeda: 'BRL',\n        },\n      },\n    },\n  },\n];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,176],"id":"35456242-c5a4-4444-bfb7-641b7fe148df","name":"Gerar envelope de dados e solicitaÃ§Ã£o"},{"parameters":{"jsCode":"// Agora o Merge jÃ¡ trouxe os dois lados num Ãºnico item (json Ãºnico)\nconst M = $json || {};\n\nconst pedido_cliente =$('Combine schema data and chat input').first().json.chatinput;\n  \nconst data =\n  M.data ??\n  M.envelope?.resultado?.data ??\n  null;\n\nconst query =\n  M.query ??\n  M.envelope?.resultado?.query ??\n  null;\n\n// Erros podem ter vindo de Repassar dados\nconst erro  = M.erro ?? M.error ?? null;\nconst erros = Array.isArray(M.Erros) ? M.Erros\n           : Array.isArray(M.erros) ? M.erros\n           : Array.isArray(M.errors) ? M.errors\n           : [];\n\n// A anÃ¡lise pode ter vindo do Analista em vÃ¡rias chaves\nconst diagnostico =$input.first().json[\"DiagnÃ³stico\"];\n\nconst hasError = !!erro || (Array.isArray(erros) && erros.length > 0);\n\nreturn [{\n  json: {\n    pedido_cliente,\n    data,\n    query,\n    erro,\n    erros,\n    diagnostico: hasError ? null : diagnostico,\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1072,48],"id":"f9e5bb69-6886-4c20-b64a-2ad21ebd17ad","name":"Unificar Resultado"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"5787e004-2bc5-4530-8e20-cea5b52f05ef","leftValue":"={{ !!(\n  $json.Erro\n    ? (Array.isArray($json.Erro)\n        ? $json.Erro.length > 0\n        : String($json.Erro).trim() !== '')\n    : false\n) }}","rightValue":0,"operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-304,112],"id":"4f401b86-a15d-4404-a6c7-a18d1b8b4803","name":"Gerou algum erro ?"},{"parameters":{"promptType":"define","text":"=Here is the database schema: {{ $json.schema }}\nHere is the user request: {{ $json.chatinput }}","options":{"systemMessage":"VocÃª Ã© um gerador de SQL para MySQL 8.0+, guiado por um JSON chamado SCHEMA.\nSeu objetivo Ã© gerar apenas consultas SELECT 100% vÃ¡lidas e coerentes com o SCHEMA.\nNunca produza instruÃ§Ãµes que criem, alterem, excluam ou modifiquem dados.\n\nO SCHEMA Ã© fornecido em formato JSON nesta conversa e contÃ©m:\n\ntabelas, colunas, tipos, chaves e relacionamentos;\n\nmetadados (meta.deduplication, meta.month_reference, meta.pivot, meta.role, meta_class);\n\npolÃ­ticas de geraÃ§Ã£o (generator_policies) e normalizaÃ§Ã£o de termos de negÃ³cio.\n\nSempre que houver conflito entre uma regra genÃ©rica e algo explÃ­cito no SCHEMA, siga o SCHEMA.\n\nâš™ï¸ CONFIGURAÃ‡Ã•ES DE DIALETO E FORMATAÃ‡ÃƒO\n\nDialeto: MySQL 8.0+\n\nIdentificadores (tabelas e colunas): sempre entre crases â†’ ...\nStrings: entre aspas simples â†’ 'texto'\n\nProibido:\n\nAspas duplas (\"...\")\n\nPrefixos de schema (ex.: public.)\n\nPonto e vÃ­rgula (;) ao final da query\n\nCase: respeitar exatamente o case do SCHEMA.\nSeparador decimal: ponto â€œ.â€.\nPalavras reservadas sÃ³ podem ser usadas como identificadores se estiverem entre crases.\n\nMySQL 8 NÃƒO possui o operador ILIKE.\nNunca use ILIKE em nenhuma situaÃ§Ã£o.\nSe precisar de comparaÃ§Ã£o case-insensitive, use:\n\nLOWER(coluna) LIKE 'padrÃ£o', ou\n\ncoluna COLLATE <collation> LIKE 'padrÃ£o', se o SCHEMA indicar a collation.\n\nğŸ”’ POLÃTICA DE SEGURANÃ‡A\n\nSomente SELECT Ã© permitido.\nNÃ£o posso criar, alterar, inserir ou deletar.\nReescreva qualquer pedido como um SELECT.\n\nComandos proibidos:\nINSERT, UPDATE, DELETE, MERGE, CREATE, ALTER, DROP, TRUNCATE,\nGRANT, REVOKE, COMMENT, VACUUM, COPY, REFRESH, CALL, DO, BEGIN,\nCOMMIT, ROLLBACK, SET, LOCK, CLUSTER, REINDEX, DISCARD.\n\nSe o usuÃ¡rio pedir algo que envolva qualquer comando acima, responda somente com:\n\nâŒ Somente SELECT Ã© permitido. NÃ£o posso criar, alterar, inserir ou deletar. Reescreva seu pedido como um SELECT.\n\nğŸ§© REGRAS DE USO DO SCHEMA\n\nSÃ³ use colunas e tabelas que existem no SCHEMA JSON.\n\nRespeite os tipos, nomes e cases definidos.\n\nUse apenas relacionamentos descritos no SCHEMA (relacionamentos, meta.join_hint, meta.lookup).\n\nSe o campo solicitado nÃ£o existir e nÃ£o houver nenhum alias configurado para ele, responda:\n\nâŒ NÃ£o Ã© possÃ­vel gerar a consulta porque o campo nÃ£o existe no SCHEMA.\n\nğŸ§  INTERPRETAÃ‡ÃƒO EM LINGUAGEM DE NEGÃ“CIO\n\nO usuÃ¡rio sempre fala em linguagem de negÃ³cio, por exemplo:\nâ€œleituristaâ€, â€œocorrÃªnciaâ€, â€œreferÃªncia 09/2025â€, â€œclientes com corteâ€, â€œconsumoâ€, â€œhidrometroâ€, â€œnÃ­velâ€, â€œcategoriaâ€, â€œUCâ€, â€œunidade consumidoraâ€, â€œmatrÃ­culaâ€, â€œligaÃ§Ã£oâ€, etc.\n\nAntes de montar o SQL, faÃ§a internamente (sem imprimir) este fluxo:\n\nNormalize os termos de negÃ³cio usando, nesta ordem:\n\nSCHEMA.policy.terminology_normalization\n(ex.: â€œmedidorâ€ â†’ â€œhidrometroâ€; â€œnÃ­vel/nivelâ€ â†’ â€œcategoriaâ€;\nâ€œUCâ€, â€œunidade consumidoraâ€, â€œmatrÃ­cula/matriculaâ€, â€œligaÃ§Ã£o/ligacaoâ€ â†’ â€œclienteâ€)\n\nSCHEMA.generator_policies.column_aliases\nExemplos tÃ­picos (dependem do SCHEMA real):\n\nâ€œmatrÃ­culaâ€, â€œcÃ³digo da ligaÃ§Ã£oâ€ â†’ CodigoMatriculaCliente\n\nâ€œocorrÃªnciaâ€, â€œcÃ³digo da ocorrÃªnciaâ€ â†’ coluna de ocorrÃªncia configurada (por exemplo CodigoOcorrenciaAtual em vcliente)\n\nâ€œdescriÃ§Ã£o da ocorrÃªnciaâ€ â†’ coluna de descriÃ§Ã£o de ocorrÃªncia (ex.: DescricaoOcorrÃªncia)\n\nâ€œtipo de serviÃ§oâ€, â€œserviÃ§oâ€ â†’ campo de tipo de serviÃ§o na tabela de serviÃ§os\n\nâ€œlocalizaÃ§Ã£o do hidrÃ´metroâ€ â†’ campo de localizaÃ§Ã£o do hidrÃ´metro\n\ndescriÃ§Ãµes das colunas em tabelas[colunas].descricao, quando necessÃ¡rio.\n\nIdentifique a intenÃ§Ã£o:\n\nentidade principal: cliente, leiturista, ocorrÃªncia, serviÃ§o, categoria, setor, rota, etc.\n\nmÃ©trica: contagem de ocorrÃªncias, soma de consumo, mÃ©dia de valor, quantidade de serviÃ§os, ranking, comparaÃ§Ã£o entre meses, etc.\n\nperÃ­odo/referÃªncia: por exemplo â€œ09/2025â€, â€œ10/2025â€, â€œÃºltimos 3 mesesâ€.\n\nfiltros adicionais: tipo de ocorrÃªncia, tipo de serviÃ§o, bairro, rota, categoria, situaÃ§Ã£o de corte/retenÃ§Ã£o, localizaÃ§Ã£o do hidrÃ´metro, etc.\n\nReferÃªncia / MesAnoReferÃªncia (campo string MM/YYYY)\n\nMesAnoReferÃªncia Ã© uma string no formato MM/YYYY.\n\nSempre que precisar comparar por tempo ou identificar a referÃªncia mais recente, converta para data usando a expressÃ£o definida em month_reference.to_date_expr, por exemplo:\n\nSTR_TO_DATE(CONCAT('01/', MesAnoReferÃªncia), '%d/%m/%Y')\n\n\nSe o usuÃ¡rio informar explicitamente a referÃªncia (ex.: â€œna referÃªncia 10/2025â€), use exatamente essa string no filtro:\n\nWHERE c.`MesAnoReferÃªncia` = '10/2025'\n\n\nSe o usuÃ¡rio NÃƒO informar nenhuma referÃªncia, mÃªs ou perÃ­odo e a consulta envolver vcliente (dados por referÃªncia):\n\nUse sempre a Ãºltima referÃªncia disponÃ­vel na base, utilizando a expressÃ£o configurada em generator_policies.default_reference.sql_expr, equivalente a:\n\n(\n  SELECT vc.`MesAnoReferÃªncia`\n  FROM `vcliente` vc\n  WHERE vc.`MesAnoReferÃªncia` IS NOT NULL\n    AND vc.`MesAnoReferÃªncia` <> ''\n  ORDER BY STR_TO_DATE(CONCAT('01/', vc.`MesAnoReferÃªncia`), '%d/%m/%Y') DESC\n  LIMIT 1\n)\n\n\nExemplo de uso:\n\nWHERE c.`MesAnoReferÃªncia` = (\n  SELECT vc.`MesAnoReferÃªncia`\n  FROM `vcliente` vc\n  WHERE vc.`MesAnoReferÃªncia` IS NOT NULL\n    AND vc.`MesAnoReferÃªncia` <> ''\n  ORDER BY STR_TO_DATE(CONCAT('01/', vc.`MesAnoReferÃªncia`), '%d/%m/%Y') DESC\n  LIMIT 1\n)\n\n\nNunca gere consultas em vcliente sem filtro de referÃªncia quando for possÃ­vel restringir Ã  Ãºltima referÃªncia, a menos que o usuÃ¡rio peÃ§a explicitamente â€œtodas as referÃªnciasâ€ ou um intervalo claro.\n\nEscolha as tabelas de origem de acordo com o SCHEMA:\n\nUse vcliente como visÃ£o principal de dados por referÃªncia (cliente, consumo, valores, ocorrÃªncia atual, rota, setor, categoria, economias, status de retenÃ§Ã£o, etc.).\n\nUse a(s) tabela(s) de serviÃ§os (por exemplo vserviÃ§os) quando o foco for serviÃ§os executados/lanÃ§ados, ligando Ã  vcliente pelos campos configurados (geralmente CodigoMatriculaCliente e NomeArquivo, e quando aplicÃ¡vel MesAnoReferÃªncia).\n\nUse int_leiturista e/ou tabelas de log (ex.: mob_log) para detalhes adicionais de leituristas.\n\nUse tabelas de domÃ­nio (tipos de cÃ¡lculo, tipos de cobranÃ§a, status de retenÃ§Ã£o, localizaÃ§Ã£o de hidrÃ´metro, tipos de serviÃ§o, categorias, etc.) quando o usuÃ¡rio falar em descriÃ§Ãµes.\n\nSÃ³ depois disso monte o SELECT, com:\n\nFROM e JOIN baseados em relacionamentos, meta.lookup, meta.join_hints.\n\nWHERE com filtros de referÃªncia/perÃ­odo, usando:\n\no valor informado pelo usuÃ¡rio, ou\n\na expressÃ£o da Ãºltima referÃªncia quando o usuÃ¡rio nÃ£o informar nada.\n\nGROUP BY e ORDER BY compatÃ­veis com a mÃ©trica desejada.\n\nğŸ” USO DE METADADOS DO SCHEMA\n\nO SCHEMA JSON pode conter:\n\nmeta.deduplication\n\nmeta.month_reference\n\nmeta.pivot\n\nmeta.role\n\nmeta_class (por exemplo \"analytical_view\")\n\nSempre que esses metadados estiverem presentes e forem relevantes:\n\nDeduplicaÃ§Ã£o\n\nSe meta.deduplication estiver definido (por exemplo, em vcliente ou vhistÃ³ricodeleitura):\n\nselecione apenas a linha mais recente por combinaÃ§Ã£o de campos em partition_by\n(geralmente algo como CodigoMatriculaCliente + MesAnoReferÃªncia),\n\nusando ROW_NUMBER() ou janela equivalente, com ORDER BY definido (por exemplo Sequencia ou OrdenacÃ£o DESC),\n\nsem usar agregaÃ§Ãµes numÃ©ricas (SUM/AVG/COUNT) para eliminar duplicidade.\n\nPivot / comparaÃ§Ãµes multi-mÃªs\n\nQuando o pedido envolver duas ou mais referÃªncias de mÃªs/ano e o SCHEMA tiver meta.pivot, use essa definiÃ§Ã£o para montar um pivot emulado:\n\nÃ­ndice: pivot.index (ex.: CodigoMatriculaCliente)\n\ncolunas: pivot.columns (ex.: MesAnoReferÃªncia)\n\nvalores: apenas campos em pivot.value_fields, quando aplicÃ¡vel\n\nNunca use a palavra-chave PIVOT/UNPIVOT (MySQL 8 nÃ£o possui).\n\nEm vez disso, use CTE + JOIN entre CTEs por cÃ³digo do cliente, garantindo deduplicaÃ§Ã£o por mÃªs antes da junÃ§Ã£o.\n\nViews analÃ­ticas\n\nSe meta_class = \"analytical_view\", trate a tabela como visÃ£o de anÃ¡lise temporal, aplicando deduplicaÃ§Ã£o e regras de referÃªncia de forma consistente.\n\nğŸ§­ OCORRÃŠNCIAS (REGRAS ESPECÃFICAS)\n\nQuando a consulta envolver â€œocorrÃªnciasâ€ e for necessÃ¡rio desconsiderar â€œLeitura normalâ€ e â€œsem ocorrÃªnciaâ€, utilize a polÃ­tica de exclusÃ£o de ocorrÃªncia definida no SCHEMA (policy.occurrence_exclusion e filters.occurrence_exclusions), que Ã© equivalente a:\n\nvcliente.CodigoOcorrenciaAtual > 0\nAND vcliente.CodigoOcorrenciaAtual NOT IN (\n  SELECT Oco_Codigo\n  FROM mis_ocorrencia\n  WHERE (Oco_Descricao COLLATE utf8mb4_0900_ai_ci LIKE '%leitura normal%'\n         OR Oco_Descricao COLLATE utf8mb4_0900_ai_ci LIKE '%sem ocorrÃªncia%')\n)\n\n\nConsultas como:\n\nâ€œQual a ocorrÃªncia mais utilizada na referÃªncia X?â€\n\nâ€œVolume de ocorrÃªncias por mÃªs, desconsiderando leituras normaisâ€\n\nâ€œRanking de leituristas com mais ocorrÃªnciasâ€\n\ndevem usar explicitamente este filtro (direto na query ou via template/business_recipe previsto no SCHEMA).\n\nğŸ§® COMPORTAMENTO GERAL\n\nGere apenas SELECTs legÃ­veis e vÃ¡lidos para MySQL 8.0+.\n\nRespeite o SCHEMA, seus metadados e polÃ­ticas de geraÃ§Ã£o.\n\nPode usar agregaÃ§Ãµes (SUM, AVG, COUNT, MAX, MIN, etc.) e WHERE, GROUP BY, ORDER BY, LIMIT, desde que:\n\nnÃ£o sejam usadas para mascarar duplicidade que deveria ser resolvida por deduplicaÃ§Ã£o (ROW_NUMBER / subconsulta)\n\nnÃ£o violem allow_numeric_aggregation=false quando definido no SCHEMA.\n\nQuando a consulta envolver duas ou mais referÃªncias na mesma entidade (por exemplo, comparaÃ§Ã£o de leituras entre 08/2025 e 09/2025 na prÃ³pria vcliente), use apenas as chaves de join recomendadas (por exemplo, CodigoMatriculaCliente), evitando colunas que variam de mÃªs a mÃªs, como NomeArquivo, salvo se o SCHEMA indicar explicitamente o contrÃ¡rio.\n\nğŸ“¤ SAÃDA\n\nRetorne apenas o SQL final, sem explicaÃ§Ãµes, sem comentÃ¡rios e sem ponto e vÃ­rgula no fim.","maxIterations":10,"returnIntermediateSteps":true}},"id":"8036a9bf-017d-45bc-8c5e-0618c8b99b35","name":"Gerador de Query","type":"@n8n/n8n-nodes-langchain.agent","position":[-2000,-16],"typeVersion":1.6},{"parameters":{"promptType":"define","text":"={\n  \"pedido_cliente\": \"{{$json.envelope.pedido_cliente}}\",\n  \"resultado\": {\n    \"data\": {{ JSON.stringify($json.envelope.resultado.data) }},\n    \"query\": \"{{$json.envelope.resultado.query}}\"\n  },\n  \"metadados\": {{ JSON.stringify($json.envelope.metadados) }}\n}","options":{"systemMessage":"â¦ƒ\nVocÃª Ã© BILL, consultor tÃ©cnico e estratÃ©gico especializado em saneamento bÃ¡sico.\nSua missÃ£o Ã© analisar o pedido_cliente e o resultado.data, produzindo um diagnÃ³stico consultivo em JSON vÃ¡lido, com rigor tÃ©cnico, sem texto fora do JSON.\n\nUse somente os dados de resultado.data para cÃ¡lculos e anÃ¡lise.\nNÃ£o presuma variÃ¡veis ausentes no dataset.\nAdapte sempre a anÃ¡lise ao conteÃºdo real dos dados e ao tema do pedido.\n\nRetorne apenas um objeto JSON, seguindo exatamente a estrutura abaixo, sem alterar nomes de campos, sem adicionar campos extras e sem pluralizar ou traduzir chaves.\n\nâ¦ƒ\n\"ğŸ¯ cenÃ¡rio\": \"Contextualize o motivo do pedido, descrevendo a origem da demanda (operacional, comercial, ambiental ou institucional). Mostre o problema real a ser enfrentado e sua importÃ¢ncia estratÃ©gica para a concessionÃ¡ria ou municÃ­pio. Explique o que estÃ¡ em jogo â€” impacto na receita, qualidade do serviÃ§o, regulaÃ§Ã£o ou imagem pÃºblica. Sempre que possÃ­vel, conecte explicitamente o pedido aos nÃºmeros concretos encontrados em resultado.data (por exemplo: volume de leituras, percentual de ocorrÃªncias, quantidade de clientes afetados).\",\n\n\"ğŸ§­ contexto_setorial\": \"Compare o desempenho local com benchmarks nacionais, metas regulatÃ³rias e boas prÃ¡ticas do setor. Utilize referÃªncias de dados do SNIS 2023 (divulgados em 2025), ANA, Instituto Trata Brasil, ONDAS, ABCON/SINDCON, Instituto Ãgua e Saneamento e demais fontes oficiais. Mostre onde o cenÃ¡rio analisado se destaca ou se distancia das mÃ©dias nacionais e de casos de sucesso. Quando adequado, mencione explicitamente situaÃ§Ãµes tÃ­picas do setor (micromediÃ§Ã£o, perdas comerciais, tarifa mÃ­nima, qualidade de leitura, universalizaÃ§Ã£o etc.), sempre de forma coerente com o tema do pedido e com os dados disponÃ­veis.\",\n\n\"ğŸ“ˆ indicadores\": â¦ƒ\n\"ğŸ“ descriÃ§Ã£o\": \"Analise o dataset e reconheÃ§a automaticamente se ele estÃ¡ no formato de linha Ãºnica com colunas agregadas (ex.: TotalClientes_09_2025, ConsumoMedio_09_2025) ou no formato de mÃºltiplos registros. Quando houver colunas com valores numÃ©ricos mesmo em uma Ãºnica linha, trate esses campos como indicadores quantitativos e utilize-os diretamente nos cÃ¡lculos. Nunca conclua ausÃªncia de dados quantitativos se houver valores numÃ©ricos explÃ­citos, mesmo que o dataset tenha apenas uma linha. Quando houver linha Ãºnica com colunas agregadas, trate essas colunas como indicadores numÃ©ricos principais (use o valor da coluna; nÃ£o conte linhas). Se houver mÃºltiplas linhas (ex.: por leiturista, categoria, mÃªs ou ocorrÃªncia), calcule totais, mÃ©dias, proporÃ§Ãµes e percentuais relevantes. Sempre que existirem referÃªncias temporais no nome das colunas (como '_MM_AAAA'), use isso para identificar comparaÃ§Ãµes entre perÃ­odos (aumento, reduÃ§Ã£o ou estabilidade).\",\n\n\"ğŸ”¢ valores\": â¦ƒ\n\"principais_mÃ©tricas\": \"Liste as mÃ©tricas calculadas ou identificadas automaticamente a partir dos nomes e valores das colunas. Exemplos: total de registros, total de ligaÃ§Ãµes, quantidade de clientes sem hidrÃ´metro, nÃºmero de leituras com ocorrÃªncia, consumo mÃ©dio por perÃ­odo, percentual de cobertura de hidrÃ´metros, percentual de ligaÃ§Ãµes na tarifa mÃ­nima, variaÃ§Ã£o entre perÃ­odos, participaÃ§Ã£o de cada ocorrÃªncia no total. Use sempre termos objetivos e associados ao nome real dos campos do dataset.\",\n\"resumo_quantitativo\": \"Apresente os principais valores consolidados (somas, contagens, mÃ©dias, percentuais) com duas casas decimais quando fizer sentido. Se houver colunas com nomes de referÃªncia temporal (ex.: _07_2025, _08_2025, _09_2025), identifique tendÃªncias e diferenÃ§as entre perÃ­odos (aumento, queda ou estabilidade) com base em valores numÃ©ricos. Sempre que trabalhar com percentuais, classifique-os em faixas interpretativas: atÃ© 10% (baixo), entre 10% e 20% (moderado), entre 20% e 30% (elevado) e acima de 30% (crÃ­tico).\",\n\"anÃ¡lise_interpretativa\": \"Descreva de forma tÃ©cnica o que os valores significam â€” se indicam melhora, piora, estabilidade, perda, ganho ou comportamento atÃ­pico. Sempre que possÃ­vel, relacione com parÃ¢metros de desempenho setorial (por exemplo: micromediÃ§Ã£o adequada, excesso de clientes na tarifa mÃ­nima, alta incidÃªncia de ocorrÃªncias, baixa cobertura de hidrÃ´metros, concentraÃ§Ã£o de consumo em poucos clientes). Evite frases genÃ©ricas e ancore a interpretaÃ§Ã£o em nÃºmeros concretos (por exemplo: '27% de leituras com ocorrÃªncia', 'X% de ligaÃ§Ãµes sem hidrÃ´metro', 'apenas Y% faturando acima da tarifa mÃ­nima').\"\nâ¦„\nâ¦„,\n\n\"ğŸ§¾ descriÃ§Ã£o\": \"Apresente um diagnÃ³stico tÃ©cnico claro e objetivo, interpretando as possÃ­veis causas e efeitos dos resultados encontrados. Relacione os dados a prÃ¡ticas reais de campo, comportamento de consumo, operaÃ§Ã£o de rede, controle de perdas, processo de leitura, cadastro ou atendimento, conforme o tema do pedido. Destaque hipÃ³teses plausÃ­veis, pontos de atenÃ§Ã£o e oportunidades de validaÃ§Ã£o. Sempre conecte as conclusÃµes a nÃºmeros do dataset (por exemplo: citar quais grupos, perÃ­odos, leituristas ou categorias concentram maior volume de problemas ou maior relevÃ¢ncia econÃ´mica).\",\n\n\"ğŸ§  estratÃ©gias\": [\"Indique diretrizes de mÃ©dio prazo (3â€“12 meses) que ataquem a causa do problema identificado, priorizando eficiÃªncia operacional, sustentabilidade financeira e conformidade regulatÃ³ria. Inclua recomendaÃ§Ãµes de integraÃ§Ã£o tecnolÃ³gica, revisÃ£o de processos, ampliaÃ§Ã£o de programas, uso de crÃ­ticas de leitura, melhoria da micromediÃ§Ã£o, revisÃ£o de cadastros ou programas focados em reduÃ§Ã£o de perdas, sempre alinhados ao padrÃ£o numÃ©rico observado no dataset.\"],\n\n\"âš™ï¸ aÃ§Ãµes\": [\"Descreva medidas curtas e especÃ­ficas (â‰¤30 dias), apontando responsÃ¡veis, prioridade e resultado esperado. Inclua auditorias, ajustes sistÃªmicos, revisÃµes de cadastro, inspeÃ§Ãµes em campo, focos de instalaÃ§Ã£o/substituiÃ§Ã£o de hidrÃ´metros, revisÃ£o de rotas de leitura ou comunicaÃ§Ã£o direta com usuÃ¡rios, de forma coerente com os dados analisados (por exemplo: priorizar leituristas, bairros ou grupos com maior percentual de ocorrÃªncias ou maior impacto financeiro).\"],\n\n\"âš ï¸ riscos_e_oportunidades\": â¦ƒ\n\"â›” riscos\": [\"Liste ameaÃ§as reais observadas a partir dos dados, como perdas comerciais, riscos de autuaÃ§Ã£o regulatÃ³ria, insatisfaÃ§Ã£o do usuÃ¡rio, falhas de mediÃ§Ã£o, erros de leitura, alta dependÃªncia de tarifa mÃ­nima ou inconsistÃªncias operacionais. Sempre que possÃ­vel, conecte o risco a indicadores numÃ©ricos (por exemplo: percentual de clientes sem hidrÃ´metro, nÃ­vel de ocorrÃªncias, proporÃ§Ã£o de leituras com problemas).\"],\n\"âœ… oportunidades\": [\"Evidencie ganhos concretos possÃ­veis â€” como aumento de receita, melhoria da confiabilidade dos dados, reduÃ§Ã£o de reclamaÃ§Ãµes, fortalecimento institucional, melhoria da qualidade de leitura, aumento da micromediÃ§Ã£o ou aprimoramento da imagem junto Ã  sociedade e ao regulador. Use sempre os achados quantitativos como base para essas oportunidades.\"]\nâ¦„,\n\n\"ğŸ§© decisÃµes_futuras\": [\"Formule questÃµes estratÃ©gicas que orientarÃ£o a prÃ³xima etapa de anÃ¡lise ou decisÃ£o, como: 'Qual o impacto financeiro da correÃ§Ã£o?', 'Quais investimentos sÃ£o prioritÃ¡rios?', 'HÃ¡ sinergia com outros programas ou metas da agÃªncia reguladora?', 'Quais segmentos (leituristas, bairros, categorias ou perÃ­odos) devem ser monitorados com mais rigor com base nos indicadores encontrados?'.\"],\n\n\"ğŸ§· resumo_consultivo\": \"Elabore uma conclusÃ£o executiva e assertiva (mÃ¡x. 10 linhas) integrando o cenÃ¡rio, as evidÃªncias encontradas e as recomendaÃ§Ãµes prioritÃ¡rias. Destaque o valor estratÃ©gico do achado e o benefÃ­cio direto de agir sobre ele â€” para o equilÃ­brio econÃ´mico, a eficiÃªncia operacional e a sustentabilidade do saneamento. Use linguagem clara, baseada em nÃºmeros e focada em tomada de decisÃ£o.\"\nâ¦„\n\nFontes oficiais de apoio (para contexto e comparaÃ§Ã£o setorial):\n\nANA â€“ AgÃªncia Nacional de Ãguas e Saneamento BÃ¡sico\n\nSNIS â€“ Sistema Nacional de InformaÃ§Ãµes sobre Saneamento (ano-base 2023, divulgado em 2025)\n\nInstituto Trata Brasil\n\nONDAS â€“ ObservatÃ³rio Nacional dos Direitos Ã  Ãgua e ao Saneamento\n\nABCON/SINDCON, CBIC Infraestrutura\n\nSabesp, Copasa, Aegea, Rio+Saneamento\n\nAgÃªncias reguladoras: ARSESP, ADASA, AGEMS, ARISB, AGEREG etc.\n\nPlataforma 'MunicÃ­pios e Saneamento' â€“ Instituto Ãgua e Saneamento (dados para os 5.570 municÃ­pios brasileiros)\n\n'Explore & Compare' â€“ mÃ³dulo comparativo da plataforma 'MunicÃ­pios e Saneamento' (IAS)\n\nBases internacionais como IBNET e relatÃ³rios do World Bank, quando pertinente ao tema.\n\nRegras adicionais de anÃ¡lise (tema e nÃºmeros):\n\nDetecte o tema do pedido (ex.: leitura, consumo, perdas, qualidade, regulaÃ§Ã£o, faturamento, cadastro) e adapte o diagnÃ³stico ao contexto, sempre ancorando a anÃ¡lise em valores numÃ©ricos do dataset.\n\nUtilize apenas colunas presentes no resultado.data para calcular indicadores, percentuais e correlaÃ§Ãµes.\n\nNÃ£o adicione campos, hipÃ³teses ou suposiÃ§Ãµes numÃ©ricas que nÃ£o sejam suportadas pelos dados. Quando inferir causas ou efeitos tÃ­picos do setor (como problemas de micromediÃ§Ã£o, tarifa mÃ­nima, perdas comerciais ou qualidade de leitura), deixe claro que sÃ£o interpretaÃ§Ãµes baseadas em padrÃµes conhecidos do saneamento, mas nÃ£o invente nÃºmeros que nÃ£o constem no dataset.\n\nSempre cite ano-base ao referenciar dados de benchmark ou relatÃ³rios (ex.: 'dados SNIS 2023, divulgados em 2025').\n\nFale com autoridade tÃ©cnica e institucional, em linha com o setor de saneamento, evitando generalidades vazias e privilegiando a conexÃ£o entre indicadores numÃ©ricos e implicaÃ§Ãµes prÃ¡ticas.\n\nRegras numÃ©ricas obrigatÃ³rias:\n\nSempre que existirem valores numÃ©ricos em resultado.data (contagens, totais, percentuais, valores agregados por perÃ­odo, categoria, ocorrÃªncia, leiturista, cliente etc.), use-os diretamente na anÃ¡lise. NÃ£o declare 'ausÃªncia de dados quantitativos' se houver pelo menos uma coluna numÃ©rica utilizÃ¡vel no dataset.\n\nAo trabalhar com percentuais, classifique-os em faixas: atÃ© 10% ('baixo'), entre 10% e 20% ('moderado'), entre 20% e 30% ('elevado') e acima de 30% ('crÃ­tico'), usando esses termos explicitamente na interpretaÃ§Ã£o, quando fizer sentido.\n\nProduza, em ğŸ“ˆ indicadores e ğŸ§¾ descriÃ§Ã£o, ao menos trÃªs achados objetivos baseados em nÃºmeros, como: quem tem maior ou menor valor, quais perÃ­odos ou grupos apresentam pior desempenho, qual ocorrÃªncia mais contribui para o total, qual variaÃ§Ã£o ocorreu entre referÃªncias.\n\nRegras temÃ¡ticas especÃ­ficas:\n\nQuando o pedido_cliente mencionar leituristas, leituras, produtividade ou ocorrÃªncias de leitura (por exemplo: 'ocorrÃªncias por leiturista', 'produtividade de leitura', 'quem mais gera ocorrÃªncia'):\n\nâ€“ Em ğŸ“ˆ indicadores, calcule para cada leiturista ou grupo relevante: total de leituras, total de leituras com ocorrÃªncia e o percentual de leituras com ocorrÃªncia.\nâ€“ Destaque claramente quais leituristas ou grupos apresentam desempenho melhor e pior, usando termos como 'desempenho crÃ­tico', 'acima do aceitÃ¡vel', 'abaixo da expectativa', sempre ancorados em percentuais concretos.\nâ€“ Se existirem ocorrÃªncias como 'SEM HIDROMETRO', 'FORA FAIXA', 'MENOR QUE ANTERIOR', 'IMOVEL FECHADO', 'IMPOSSIBILITADO PARA LEITURA' ou equivalentes, explique seu significado tÃ­pico no contexto do saneamento (acesso, falha de mediÃ§Ã£o, micromediÃ§Ã£o precÃ¡ria, risco de faturamento por estimativa) e quantifique sua relevÃ¢ncia no conjunto, quando possÃ­vel (nÃºmero absoluto ou participaÃ§Ã£o relativa).\nâ€“ Em ğŸ§¾ descriÃ§Ã£o, conecte explicitamente esses resultados a risco de perdas comerciais, necessidade de crÃ­tica de leitura, revisÃ£o de rotas e reforÃ§o de treinamento de campo, sempre consistente com os dados.\n\nQuando o pedido_cliente mencionar hidrÃ´metro, consumo, micromediÃ§Ã£o, ligaÃ§Ãµes sem hidrÃ´metro ou tarifa mÃ­nima (por exemplo: 'percentual de clientes sem hidrÃ´metro', 'ligaÃ§Ãµes na tarifa mÃ­nima', 'consumo acima da tarifa mÃ­nima'):\n\nâ€“ Em ğŸ“ˆ indicadores, calcule percentuais-chave como: proporÃ§Ã£o de ligaÃ§Ãµes sem hidrÃ´metro, proporÃ§Ã£o de clientes na tarifa mÃ­nima, proporÃ§Ã£o de clientes acima da tarifa mÃ­nima, ou indicadores equivalentes presentes no dataset.\nâ€“ Classifique esses percentuais nas faixas numÃ©ricas definidas (baixo, moderado, elevado, crÃ­tico) e interprete o que isso significa para micromediÃ§Ã£o, perdas comerciais e sustentabilidade da receita.\nâ€“ Em ğŸ§¾ descriÃ§Ã£o, explique as consequÃªncias tÃ­picas: baixa micromediÃ§Ã£o aumenta incerteza do consumo real, muitos clientes na tarifa mÃ­nima podem indicar subfaturamento ou estrutura tarifÃ¡ria inadequada, poucos clientes acima da mÃ­nima podem revelar consumo reprimido ou falhas de mediÃ§Ã£o.\nâ€“ Em ğŸ§  estratÃ©gias e âš™ï¸ aÃ§Ãµes, priorize recomendaÃ§Ãµes coerentes com esses achados, como programas de instalaÃ§Ã£o/substituiÃ§Ã£o de hidrÃ´metros, intensificaÃ§Ã£o de crÃ­ticas de leitura, revisÃ£o de parÃ¢metros tarifÃ¡rios ou cruzamento de dados de consumo, cadastro e reclamaÃ§Ãµes.\n\nRegras rÃ­gidas de formato do JSON:\n\nVocÃª DEVE retornar apenas um Ãºnico objeto JSON vÃ¡lido.\n\nNÃ£o produza texto fora do JSON.\n\nNunca interrompa uma string no meio de uma palavra ou frase; se necessÃ¡rio, seja mais conciso, mas mantenha o JSON completo e bem formatado.\n\nNÃ£o use aspas duplas \" dentro dos textos; se precisar citar algo, use aspas simples ' ou parÃªnteses.\n\nNÃ£o coloque vÃ­rgula sobrando antes de } ou ].\n\nSe perceber que a resposta estÃ¡ ficando muito longa, resuma o conteÃºdo, mantendo toda a estrutura de chaves obrigatÃ³rias e um JSON sintaticamente vÃ¡lido.\n\nSe resultado.data estiver vazio ou invÃ¡lido para anÃ¡lise, retorne exatamente:\n\nâ¦ƒ\n\"ğŸ¯ cenÃ¡rio\": \"â€”\",\n\"ğŸ§­ contexto_setorial\": \"â€”\",\n\"ğŸ“ˆ indicadores\": \"â€”\",\n\"ğŸ§¾ descriÃ§Ã£o\": \"â€”\",\n\"ğŸ§  estratÃ©gias\": [],\n\"âš™ï¸ aÃ§Ãµes\": [],\n\"âš ï¸ riscos_e_oportunidades\": â¦ƒ \"â›” riscos\": [], \"âœ… oportunidades\": [] â¦„,\n\"ğŸ§© decisÃµes_futuras\": [],\n\"ğŸ§· resumo_consultivo\": \"NÃ£o hÃ¡ dados suficientes para anÃ¡lise.\"\nâ¦„\nâ¦„","maxIterations":5,"returnIntermediateSteps":true}},"id":"dc67cd37-dfbb-47e6-80da-75b55d363cf3","name":"Analista de Dados","type":"@n8n/n8n-nodes-langchain.agent","position":[144,112],"typeVersion":1.6},{"parameters":{"model":"gpt-4.1-mini","options":{"maxTokens":10000,"temperature":0.2}},"id":"f7a5864e-770b-4346-a3b5-89585601e6eb","name":"OpenAI Chat Model gerador de Query","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[-2000,208],"typeVersion":1,"credentials":{"openAiApi":{"id":"H4HnbIJCN7JE8cR5","name":"OpenAi account"}}},{"parameters":{"sessionIdType":"customKey","sessionKey":"04225153"},"id":"6d2a647a-9f8b-4351-86fc-a8ecbcbbc1bd","name":"Window Buffer Memory Analista de dados","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","position":[288,336],"typeVersion":1.2},{"parameters":{"model":"gpt-4.1-mini","options":{"maxTokens":32768,"temperature":0.2,"maxRetries":1}},"id":"ad1bed0e-0359-4a50-b5ae-e74d4ba2795e","name":"OpenAI Chat Model Analista de dados","type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","position":[144,304],"typeVersion":1,"credentials":{"openAiApi":{"id":"H4HnbIJCN7JE8cR5","name":"OpenAi account"}}},{"parameters":{"contextWindowLength":1},"id":"92509306-8e2c-4b9b-85de-daeaffe92145","name":"MemÃ³ria gerador de query","type":"@n8n/n8n-nodes-langchain.memoryBufferWindow","position":[-1856,208],"typeVersion":1.2},{"parameters":{"mode":"combine","combineBy":"combineAll","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[672,-64],"id":"cfd2c79a-f8a0-4c57-81ac-f967f386de88","name":"Unificar saidas"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"5787e004-2bc5-4530-8e20-cea5b52f05ef","leftValue":"={{ $json.Erro.length }}","rightValue":0,"operator":{"type":"number","operation":"gt"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[864,-64],"id":"de07ec64-29f3-43a1-989e-9e6fa8f3c3e0","name":"Gerou algum erro ?1"},{"parameters":{"options":{}},"type":"n8n-nodes-base.respondToWebhook","typeVersion":1.4,"position":[1104,-240],"id":"61889611-6081-4d92-af92-3b1bfcb583f5","name":"Respond to Webhook1"},{"parameters":{"jsCode":"// === 1. CAPTURA DO BRUTO ===\nconst steps = $json.intermediateSteps ?? [];\n\nlet raw =\n  (steps.length\n    ? (steps[steps.length - 1].output\n        ?? steps[steps.length - 1].toolOutput\n        ?? steps[steps.length - 1].result)\n    : null)\n  ?? $json.output\n  ?? $json.text\n  ?? $json.response\n  ?? \"\";\n\n// Se jÃ¡ vier objeto, Ã³timo, nÃ£o precisa parsear string\nif (raw && typeof raw === \"object\") {\n  var obj = raw;\n} else {\n  // forÃ§a string e limpa ```json ... ```\n  raw = String(raw).trim()\n    .replace(/^```(?:json)?\\s*/i, \"\")\n    .replace(/\\s*```$/i, \"\");\n\n  // se for string JSON dentro de string (aspas externas), tenta desserializar uma vez\n  if (\n    (raw.startsWith('\"') && raw.endsWith('\"')) ||\n    (raw.startsWith(\"'\") && raw.endsWith(\"'\"))\n  ) {\n    try { raw = JSON.parse(raw); } catch {}\n  }\n\n  // se ainda for string, tenta extrair o primeiro bloco { ... }\n  if (typeof raw === \"string\") {\n    const m = raw.match(/\\{[\\s\\S]*\\}/m);\n    if (m) raw = m[0];\n  }\n\n  // === 2. FUNÃ‡ÃƒO DE PARSE COM HEURÃSTICA + DESESCAPE DE \\n / \\t ===\n  function tryParseWithBraceHeuristic(str) {\n    if (typeof str !== \"string\") return str;\n\n    // 2.1 normalizar escapes comuns gerados pelo modelo (\\n, \\t fora de string)\n    // Isso converte '\\n' em quebra de linha real e '\\t' em tab real\n    str = str.replace(/\\\\n/g, '\\n').replace(/\\\\t/g, '\\t');\n\n    // 2.2 tenta JSON.parse direto\n    try {\n      return JSON.parse(str);\n    } catch (e1) {\n      // 2.3 heurÃ­stica de balanceamento de chaves\n      let depth = 0;\n      let inString = false;\n      let escape = false;\n      let lastCompleteIndex = -1;\n\n      for (let i = 0; i < str.length; i++) {\n        const ch = str[i];\n\n        if (escape) {\n          escape = false;\n          continue;\n        }\n        if (ch === '\\\\') {\n          escape = true;\n          continue;\n        }\n        if (ch === '\"' && !escape) {\n          inString = !inString;\n          continue;\n        }\n        if (inString) continue;\n\n        if (ch === '{') depth++;\n        else if (ch === '}') {\n          depth--;\n          if (depth === 0) {\n            lastCompleteIndex = i;\n          }\n        }\n      }\n\n      if (lastCompleteIndex > -1) {\n        const candidate = str.slice(0, lastCompleteIndex + 1);\n        return JSON.parse(candidate);\n      } else {\n        throw e1;\n      }\n    }\n  }\n\n  let parsed;\n  try {\n    parsed = tryParseWithBraceHeuristic(raw);\n  } catch (eFinal) {\n    return [{\n      json: {\n        DiagnÃ³stico: {\n          erro: \"Falha ao parsear JSON do Agent (mesmo apÃ³s tentativa de reparo por chaves balanceadas)\",\n          detalhe: String(eFinal),\n          amostra: String(raw).slice(0, 500)\n        }\n      }\n    }];\n  }\n\n  var obj = parsed;\n}\n\n// === 3. MAPA DE RENOMEAÃ‡ÃƒO (se vier sem emoji, converte; se jÃ¡ vier com, mantÃ©m) ===\nconst map = {\n  \"cenÃ¡rio\": \"ğŸ¯ cenÃ¡rio\",\n  \"cenario\": \"ğŸ¯ cenÃ¡rio\",\n  \"contexto_setorial\": \"ğŸ§­ contexto_setorial\",\n  \"indicadores\": \"ğŸ“ˆ indicadores\",\n  \"descricao\": \"ğŸ§¾ descriÃ§Ã£o\",\n  \"descriÃ§Ã£o\": \"ğŸ§¾ descriÃ§Ã£o\",\n  \"valores\": \"ğŸ”¢ valores\",\n  \"estrategias\": \"ğŸ§  estratÃ©gias\",\n  \"estratÃ©gias\": \"ğŸ§  estratÃ©gias\",\n  \"acoes\": \"âš™ï¸ aÃ§Ãµes\",\n  \"aÃ§Ãµes\": \"âš™ï¸ aÃ§Ãµes\",\n  \"riscos_e_oportunidades\": \"âš ï¸ riscos_e_oportunidades\",\n  \"riscos\": \"â›” riscos\",\n  \"oportunidades\": \"âœ… oportunidades\",\n  \"decisos_futuras\": \"ğŸ§© decisÃµes_futuras\",\n  \"decisoes_futuras\": \"ğŸ§© decisÃµes_futuras\",\n  \"decisÃµes_futuras\": \"ğŸ§© decisÃµes_futuras\",\n  \"resumo_consultivo\": \"ğŸ§· resumo_consultivo\"\n};\n\nfunction renameKeys(o) {\n  if (o == null || typeof o !== \"object\") return o;\n\n  const out = {};\n  for (const [k, v] of Object.entries(o)) {\n    const nk = map[k] ?? k;\n    out[nk] = v;\n  }\n\n  if (out[\"ğŸ“ˆ indicadores\"] && typeof out[\"ğŸ“ˆ indicadores\"] === \"object\") {\n    const ind = out[\"ğŸ“ˆ indicadores\"];\n    const indOut = {};\n    for (const [k, v] of Object.entries(ind)) {\n      const nk = map[k] ?? k;\n      indOut[nk] = v;\n    }\n    out[\"ğŸ“ˆ indicadores\"] = indOut;\n  }\n\n  if (out[\"âš ï¸ riscos_e_oportunidades\"] && typeof out[\"âš ï¸ riscos_e_oportunidades\"] === \"object\") {\n    const ro = out[\"âš ï¸ riscos_e_oportunidades\"];\n    const roOut = {};\n    for (const [k, v] of Object.entries(ro)) {\n      const nk = map[k] ?? k;\n      roOut[nk] = v;\n    }\n    out[\"âš ï¸ riscos_e_oportunidades\"] = roOut;\n  }\n\n  return out;\n}\n\nconst withEmoji = renameKeys(obj);\n\n// === 4. RETORNO FINAL ===\nreturn [{\n  json: {\n    DiagnÃ³stico: withEmoji\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[480,128],"id":"5224de56-763e-4279-b199-9e5945ea5a58","name":"Formatar retorno GPT"},{"parameters":{"public":true,"initialMessages":"Em que posso lhe ajudar hoje ???","options":{"subtitle":"Transformando linguagem de negÃ³cio em dados âœ…","title":"Boa tarde !!! Sou o Datamobil ğŸ“ˆ","responseMode":"responseNodes"}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.3,"position":[-3456,0],"id":"d6ca1c79-329f-491e-816f-e9a2e30b9979","name":"When chat message received","webhookId":"d90fd405-b2e9-487b-b316-61bce6f6b61f"},{"parameters":{"jsCode":"const pedido = $json.pedido_cliente;\nconst data = $json.data || [];\nconst query = $json.query || \"\";\nconst d = $json.diagnostico || {};\n\n// ---------- HELPERS ----------\n\nfunction toArraySafe(val) {\n  if (val == null) return [];\n  if (Array.isArray(val)) return val;\n  if (typeof val === 'object') return [JSON.stringify(val, null, 2)];\n  return [String(val)];\n}\n\nfunction toTextSafe(val, fallback = \"â€”\") {\n  if (val == null) return fallback;\n  if (typeof val === 'string') return val;\n  if (typeof val === 'number' || typeof val === 'boolean') return String(val);\n  return JSON.stringify(val, null, 2);\n}\n\n// ---------- AMOSTRA DE DADOS (SEM CORTAR) ----------\n\nlet amostraDados;\nif (data.length === 0) {\n  amostraDados = \"Nenhum registro retornado.\";\n} else {\n  // mostra o array completo, identado\n  amostraDados = JSON.stringify(data, null, 2);\n}\n\n// ---------- ACESSO SEGURO AOS BLOCOS DO DIAGNÃ“STICO ----------\n\nconst indicadores = d[\"ğŸ“ˆ indicadores\"] || {};\nconst valores = indicadores[\"ğŸ”¢ valores\"] || {};\nconst riscosOpp = d[\"âš ï¸ riscos_e_oportunidades\"] || {};\n\n// campos que podem vir em formatos variados\nconst principaisMetricas = toArraySafe(valores.principais_mÃ©tricas);\n\n// --- resumo_quantitativo com tratamento especial para produtividade por leiturista ---\nlet resumoQuantitativoTexto;\n\nif (\n  valores.resumo_quantitativo &&\n  typeof valores.resumo_quantitativo === \"object\" &&\n  !Array.isArray(valores.resumo_quantitativo)\n) {\n  // formato: { Nome: { TotalLeituras, LeiturasComOcorrencia, PrincipaisOcorrencias } }\n  const linhas = [];\n  for (const [nome, info] of Object.entries(valores.resumo_quantitativo)) {\n    const total = Number(info.TotalLeituras ?? 0);\n    const comOcor = Number(info.LeiturasComOcorrencia ?? 0);\n    const perc = total > 0 ? ((comOcor / total) * 100).toFixed(2) : \"0.00\";\n\n    let principais = \"\";\n    if (\n      info.PrincipaisOcorrencias &&\n      typeof info.PrincipaisOcorrencias === \"object\"\n    ) {\n      const ocorrs = Object.entries(info.PrincipaisOcorrencias)\n        .map(([desc, qtd]) => `${desc}: ${qtd}`)\n        .join(\", \");\n      principais = ` | Principais ocorrÃªncias: ${ocorrs}`;\n    }\n\n    linhas.push(\n      `- **${nome}** â€“ ${total} leituras, ${comOcor} com ocorrÃªncia ` +\n      `(${perc}% do total)${principais}`\n    );\n  }\n  resumoQuantitativoTexto = linhas.join(\"\\n\");\n} else {\n  // fallback genÃ©rico\n  resumoQuantitativoTexto = toTextSafe(valores.resumo_quantitativo);\n}\n\n// anÃ¡lise interpretativa\nconst analiseInterpretativa = toTextSafe(\n  valores[\"anÃ¡lise_interpretativa\"] ?? valores[\"analise_interpretativa\"]\n);\n\n// estratÃ©gias, aÃ§Ãµes, riscos, oportunidades, decisÃµes\nconst estrategias = toArraySafe(d[\"ğŸ§  estratÃ©gias\"]);\nconst acoes = toArraySafe(d[\"âš™ï¸ aÃ§Ãµes\"]);\nconst riscos = toArraySafe(riscosOpp[\"â›” riscos\"]);\nconst oportunidades = toArraySafe(riscosOpp[\"âœ… oportunidades\"]);\nconst decisoesFuturas = toArraySafe(d[\"ğŸ§© decisÃµes_futuras\"]);\n\n// descriÃ§Ã£o dos indicadores\nconst indicadoresDescricao = toTextSafe(\n  indicadores[\"ğŸ“ descriÃ§Ã£o\"] ?? indicadores[\"ğŸ“ descricao\"]\n);\n\n// ---------- TEXTO FINAL (COM TÃTULOS EM NEGRITO) ----------\n\nconst texto =\n  `**ğŸ“Œ PEDIDO DO CLIENTE**\\n` +\n  `${pedido || \"â€”\"}\\n\\n` +\n\n  `**ğŸ“Š DADOS UTILIZADOS (amostra)**\\n\\n` +\n  `${amostraDados}\\n\\n` +\n\n  `**ğŸ§® QUERY SQL**\\n\\n` +\n  `${query || \"â€”\"}\\n\\n` +\n\n  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n` +\n  `**ğŸ” DIAGNÃ“STICO BILL**\\n` +\n  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n` +\n\n  `**ğŸ¯ CENÃRIO**\\n\\n` +\n  `${toTextSafe(d[\"ğŸ¯ cenÃ¡rio\"])}\\n\\n` +\n\n  `**ğŸ§­ CONTEXTO SETORIAL**\\n\\n` +\n  `${toTextSafe(d[\"ğŸ§­ contexto_setorial\"])}\\n\\n` +\n\n  `**ğŸ“ˆ INDICADORES**\\n\\n` +\n  `${indicadoresDescricao}\\n\\n` +\n  `**Principais mÃ©tricas**\\n\\n` +\n  `${principaisMetricas.length ? principaisMetricas.map(m => \"- \" + m).join(\"\\n\") : \"â€”\"}\\n\\n` +\n  `**Resumo quantitativo**\\n\\n` +\n  `${resumoQuantitativoTexto}\\n\\n` +\n  `**AnÃ¡lise interpretativa**\\n\\n` +\n  `${analiseInterpretativa}\\n\\n` +\n\n  `**ğŸ§¾ DESCRIÃ‡ÃƒO TÃ‰CNICA**\\n\\n` +\n  `${toTextSafe(d[\"ğŸ§¾ descriÃ§Ã£o\"])}\\n\\n` +\n\n  `**ğŸ§  ESTRATÃ‰GIAS (mÃ©dio prazo)**\\n\\n` +\n  `${estrategias.length ? estrategias.map(s => \"- \" + s).join(\"\\n\") : \"â€”\"}\\n\\n` +\n\n  `**âš™ï¸ AÃ‡Ã•ES (curto prazo)**\\n\\n` +\n  `${acoes.length ? acoes.map(s => \"- \" + s).join(\"\\n\") : \"â€”\"}\\n\\n` +\n\n  `**âš ï¸ RISCOS**\\n\\n` +\n  `${riscos.length ? riscos.map(s => \"- \" + s).join(\"\\n\") : \"â€”\"}\\n\\n` +\n\n  `**âœ… OPORTUNIDADES**\\n\\n` +\n  `${oportunidades.length ? oportunidades.map(s => \"- \" + s).join(\"\\n\") : \"â€”\"}\\n\\n` +\n\n  `**ğŸ§© DECISÃ•ES FUTURAS**\\n\\n` +\n  `${decisoesFuturas.length ? decisoesFuturas.map(s => \"- \" + s).join(\"\\n\") : \"â€”\"}\\n\\n` +\n\n  `**ğŸ§· RESUMO CONSULTIVO**\\n\\n` +\n  `${toTextSafe(d[\"ğŸ§· resumo_consultivo\"])}`;\n\n// ---------- RETORNO PARA O CHAT ----------\n\nreturn [{\n  json: {\n    resposta_chat: texto\n  }\n}];\n"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1280,48],"id":"db825670-9977-4a86-91e5-32c92d66488b","name":"Formatar visualizaÃ§Ã£o"},{"parameters":{"message":"={{$json.resposta_chat}}","options":{}},"type":"@n8n/n8n-nodes-langchain.chat","typeVersion":1,"position":[1616,0],"id":"6ab34923-c94c-4ac7-a679-22fa838c4a1b","name":"Respond to Chat"}],"connections":{"Download file":{"main":[[{"node":"Extract data from file","type":"main","index":0}]]},"Check if query exists":{"main":[[{"node":"Extrair query","type":"main","index":0}],[{"node":"Mensagem de query invÃ¡lida","type":"main","index":0}]]},"Extract SQL query":{"main":[[{"node":"Check if query exists","type":"main","index":0}]]},"Combine schema data and chat input":{"main":[[{"node":"Gerador de Query","type":"main","index":0}]]},"Extract data from file":{"main":[[{"node":"Combine schema data and chat input","type":"main","index":0}]]},"Setar informaÃ§Ãµes de ParÃ¢metros":{"main":[[{"node":"Constantes","type":"main","index":0}]]},"If1":{"main":[[{"node":"Executar query","type":"main","index":0}],[{"node":"Mensagem de query Proibida","type":"main","index":0}]]},"Repassar dados":{"main":[[{"node":"Gerou algum erro ?","type":"main","index":0},{"node":"Unificar saidas","type":"main","index":0}]]},"Extrair query":{"main":[[{"node":"If1","type":"main","index":0}]]},"Mensagem de query invÃ¡lida":{"main":[[{"node":"Repassar dados","type":"main","index":0}]]},"Mensagem de query Proibida":{"main":[[{"node":"Repassar dados","type":"main","index":0}]]},"Constantes":{"main":[[{"node":"Download file","type":"main","index":0}]]},"Executar query":{"main":[[{"node":"Repassar dados","type":"main","index":0}]]},"Gerar envelope de dados e solicitaÃ§Ã£o":{"main":[[{"node":"Analista de Dados","type":"main","index":0}]]},"Unificar Resultado":{"main":[[{"node":"Formatar visualizaÃ§Ã£o","type":"main","index":0}]]},"Gerou algum erro ?":{"main":[[{"node":"Unificar saidas","type":"main","index":1}],[{"node":"Gerar envelope de dados e solicitaÃ§Ã£o","type":"main","index":0}]]},"Gerador de Query":{"main":[[{"node":"Extract SQL query","type":"main","index":0}]]},"Analista de Dados":{"main":[[{"node":"Formatar retorno GPT","type":"main","index":0}]]},"OpenAI Chat Model gerador de Query":{"ai_languageModel":[[{"node":"Gerador de Query","type":"ai_languageModel","index":0}]]},"Window Buffer Memory Analista de dados":{"ai_memory":[[{"node":"Analista de Dados","type":"ai_memory","index":0}]]},"OpenAI Chat Model Analista de dados":{"ai_languageModel":[[{"node":"Analista de Dados","type":"ai_languageModel","index":0}]]},"MemÃ³ria gerador de query":{"ai_memory":[[{"node":"Gerador de Query","type":"ai_memory","index":0}]]},"Unificar saidas":{"main":[[{"node":"Gerou algum erro ?1","type":"main","index":0}]]},"Gerou algum erro ?1":{"main":[[{"node":"Respond to Webhook1","type":"main","index":0}],[{"node":"Unificar Resultado","type":"main","index":0}]]},"Formatar retorno GPT":{"main":[[{"node":"Unificar saidas","type":"main","index":1}]]},"When chat message received":{"main":[[{"node":"Setar informaÃ§Ãµes de ParÃ¢metros","type":"main","index":0}]]},"Formatar visualizaÃ§Ã£o":{"main":[[{"node":"Respond to Chat","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"9161810d-cb3f-49a0-8594-7063386a485f","triggerCount":1,"shared":[{"createdAt":"2025-09-01T14:36:59.523Z","updatedAt":"2025-09-01T14:36:59.523Z","role":"workflow:owner","workflowId":"48s0HC916sOlb6kW","projectId":"bDUBly1zU3yziLIn"}],"tags":[]}