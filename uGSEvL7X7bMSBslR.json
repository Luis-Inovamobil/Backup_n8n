{
  "id": "uGSEvL7X7bMSBslR",
  "name": "Datamobil - Reader Web + AnÃ¡lise - HomologaÃ§Ã£o",
  "createdAt": "2025-11-18T14:34:56.611Z",
  "updatedAt": "2025-12-04T11:43:38.000Z",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "1QQSmwbXjo0-jTDq2a0_TrhvPruhROeON",
          "mode": "list",
          "cachedResultName": "ReaderWeb.json",
          "cachedResultUrl": "https://drive.google.com/file/d/1QQSmwbXjo0-jTDq2a0_TrhvPruhROeON/view?usp=drivesdk"
        },
        "options": {
          "binaryPropertyName": "json"
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -3776,
        224
      ],
      "id": "3c6f1687-74e0-467c-a543-43f41cc1a99f",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "A7dItjE7OWcTVPSQ",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "5f3b3c30-78e9-4ed0-b520-9153664540ec",
              "leftValue": "={{ $json.query }}",
              "rightValue": "SELECT",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            },
            {
              "id": "46b1dd62-2b29-409b-81ed-590c3703721f",
              "leftValue": "={{ $json.query }}",
              "rightValue": "OlÃ¡",
              "operator": {
                "type": "string",
                "operation": "notContains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "dfc18e33-2b88-44a1-aa88-6bb88d9f5e4d",
      "name": "Check if query exists",
      "type": "n8n-nodes-base.if",
      "position": [
        -2528,
        224
      ],
      "typeVersion": 2.2
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ebbe194a-4b8b-44c9-ac19-03cf69d353bf",
              "name": "query",
              "type": "string",
              "value": "={{ ($json.output) }}"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": "d67d6f29-214b-48fa-9499-4ec5e4ec622d",
      "name": "Extract SQL query",
      "type": "n8n-nodes-base.set",
      "position": [
        -2752,
        224
      ],
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f78c57d9-df13-43c7-89a7-5387e528107e",
              "name": "chatinput",
              "type": "string",
              "value": "={{ $('When chat message received').item.json.chatInput }}"
            },
            {
              "id": "e42b39eb-dfbd-48d9-94ed-d658bdd41454",
              "name": "schema",
              "type": "string",
              "value": "={{ $json.json }}"
            }
          ]
        },
        "options": {}
      },
      "id": "a8a28017-d035-444a-bc03-83358e309377",
      "name": "Combine schema data and chat input",
      "type": "n8n-nodes-base.set",
      "position": [
        -3328,
        224
      ],
      "executeOnce": true,
      "typeVersion": 3.4
    },
    {
      "parameters": {
        "operation": "fromJson",
        "binaryPropertyName": "json",
        "destinationKey": "***MASKED_SECRET***",
        "options": {
          "encoding": "utf8"
        }
      },
      "id": "bde67a51-98fb-4e3d-94ab-d0d27cda85e2",
      "name": "Extract data from file",
      "type": "n8n-nodes-base.extractFromFile",
      "position": [
        -3552,
        224
      ],
      "typeVersion": 1
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b86f4807-aff3-42fb-a110-f43653368396",
              "name": "Solicitacao",
              "value": "={{ $json.query.Solicitacao }}",
              "type": "string"
            },
            {
              "id": "66447438-499c-4ab3-88ee-e20835aa7618",
              "name": "CodigoIManager",
              "value": "={{ $json.query.CodigoIManager }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4224,
        224
      ],
      "id": "d11ea7d9-94ee-41eb-80d4-5766e5b2a5cf",
      "name": "Setar informaÃ§Ãµes de ParÃ¢metros"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f8f105fa-8e7c-4309-9cd9-9a5c987ed77f",
              "leftValue": "={{ $json.allowed }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -2080,
        128
      ],
      "id": "df4c2c52-cbdc-457e-b374-44047a5ecc8f",
      "name": "If1"
    },
    {
      "parameters": {
        "jsCode": "// Run Once for All Items\n\nconst items = $input.all();\n\n// --- Utils ------------------------------------------------------------------\n\nfunction hasMeaningfulContent(o, depth = 0) {\n  if (o == null) return false;\n  if (typeof o !== 'object') return String(o).trim() !== '';\n  if (depth > 6) return true;\n  if (Array.isArray(o)) return o.some(v => hasMeaningfulContent(v, depth + 1));\n  const keys = Object.keys(o);\n  if (keys.length === 0) return false;\n  return keys.some(k => hasMeaningfulContent(o[k], depth + 1));\n}\n\nfunction collectErrorsDeep(obj, found = []) {\n  if (obj == null) return found;\n\n  const pushErr = (val) => {\n    if (val == null) return;\n    const msg = typeof val === 'object' ? JSON.stringify(val) : String(val);\n    if (msg.trim()) found.push(msg.trim());\n  };\n\n  if (Array.isArray(obj)) {\n    for (const v of obj) collectErrorsDeep(v, found);\n    return found;\n  }\n\n  if (typeof obj === 'object') {\n    for (const [k, v] of Object.entries(obj)) {\n      const lower = k.toLowerCase();\n      if (lower === 'erro' || lower === 'error') pushErr(v);\n      else if (lower === 'message' && typeof v === 'string') pushErr(v);\n      collectErrorsDeep(v, found);\n    }\n    return found;\n  }\n\n  return found;\n}\n\nfunction dedupStrings(arr) {\n  const seen = new Set();\n  const out = [];\n  for (const s of arr) if (!seen.has(s)) { seen.add(s); out.push(s); }\n  return out;\n}\n\n// PreferÃªncia do Luis: $json.message.content.data\nfunction extractUsefulPayload(j) {\n  if (Array.isArray(j?.message?.content?.data)) return j.message.content.data.slice();\n  if (Array.isArray(j?.data)) return j.data.slice();\n  if (hasMeaningfulContent(j)) return [j];\n  return [];\n}\n\nfunction normalizeList(list) {\n  return list\n    .map(x => (x?.json ?? x))\n    .filter(o => hasMeaningfulContent(o))\n    .map(o => (typeof o === 'object' ? o : { value: o }));\n}\n\n// Captura a query de forma resiliente (suporta Set, Function e mesmo payload)\nfunction safeGetQuery() {\n  // 1) Se a query veio nos itens de entrada\n  for (const it of items) {\n    const j = it?.json ?? {};\n    const q = j.query ?? j.sql ?? j.consulta;\n    if (typeof q === 'string' && q.trim()) return q.trim();\n  }\n\n  // 2) Caso a query esteja em outro nÃ³ do fluxo\n  try {\n    // Altere o nome abaixo para o nÃ³ onde a SQL Ã© montada (ex: \"Extract SQL query\" ou \"Montar Query\")\n    const fromNode = $items('Extract SQL query', 0, 0);\n    for (const it of fromNode ?? []) {\n      const j = it?.json ?? {};\n      const q = j.query ?? j.sql ?? j.consulta;\n      if (typeof q === 'string' && q.trim()) return q.trim();\n    }\n  } catch (_) { /* ignora erros */ }\n\n  return null; // nÃ£o encontrada\n}\n\n// ----------------------- USAGE (tokens) -------------------------------------\n\nfunction findUsageIn(obj) {\n  if (obj == null) return null;\n\n  if (Array.isArray(obj)) {\n    for (const el of obj) {\n      const found = findUsageIn(el);\n      if (found) return found;\n    }\n    return null;\n  }\n\n  if (typeof obj === 'object') {\n    if (obj.usage && typeof obj.usage === 'object') {\n      const u = obj.usage;\n      const total =\n        typeof u.total_tokens === 'number'\n          ? u.total_tokens\n          : (typeof u.input_tokens === 'number' && typeof u.output_tokens === 'number'\n              ? u.input_tokens + u.output_tokens\n              : undefined);\n\n      return {\n        input_tokens: typeof u.input_tokens === 'number' ? u.input_tokens : undefined,\n        output_tokens: typeof u.output_tokens === 'number' ? u.output_tokens : undefined,\n        total_tokens: typeof total === 'number' ? total : undefined,\n      };\n    }\n\n    for (const v of Object.values(obj)) {\n      const found = findUsageIn(v);\n      if (found) return found;\n    }\n  }\n\n  return null;\n}\n\nfunction safeGetUsage() {\n  // 1) Tenta achar usage nos prÃ³prios itens de entrada\n  for (const it of items) {\n    const j = it?.json ?? {};\n    const usage = findUsageIn(j);\n    if (usage) return usage;\n  }\n\n  // 2) Tenta achar usage no nÃ³ \"GPT gerar query\"\n  try {\n    const fromNode = $items('GPT gerar query'); // <<--- AQUI entra o seu nÃ³\n    for (const it of fromNode ?? []) {\n      const j = it?.json ?? {};\n      const usage = findUsageIn(j);\n      if (usage) return usage;\n    }\n  } catch (_) { /* ignora erros */ }\n\n  return null;\n}\n\n// --- Fluxo ------------------------------------------------------------------\n\n// 1) Sem entradas\nif (!items || items.length === 0) {\n  return [{ json: { Erro: 'NÃ£o foram encontrados dados para esta solicitaÃ§Ã£o' } }];\n}\n\n// 2) Procure erros em todo o payload bruto\nlet erros = [];\nfor (const it of items) {\n  const j = it?.json ?? {};\n  collectErrorsDeep(j, erros);\n}\nerros = dedupStrings(erros);\n\n// 3) Se achou erro, retorna somente { Erro: \"texto do erro\" }\nif (erros.length > 0) {\n  const j0 = items[0]?.json ?? {};\n\n  // Tenta pegar apenas o campo \"text\" do erro (formato do GPT)\n  let texto =\n    j0?.erro?.[0]?.content?.[0]?.text\n    ?? erros[0]\n    ?? 'Erro nÃ£o identificado';\n\n  return [{ json: { Erro: texto } }];\n}\n\n\n\n// 4) Extrair dados dos formatos suportados\nlet all = [];\nfor (const it of items) {\n  const j = it?.json ?? {};\n  all.push(...extractUsefulPayload(j));\n}\n\n// 5) Fallback: cada item.json\nif (all.length === 0) {\n  all = items.map(i => i?.json ?? {});\n}\n\n// 6) Checar erros dentro da lista\nlet innerErrors = [];\ncollectErrorsDeep(all, innerErrors);\ninnerErrors = dedupStrings(innerErrors);\nif (innerErrors.length > 0) {\n  return [{ json: { Erro: innerErrors[0] } }];\n}\n\n// 7) Limpeza de dados\nconst rows = normalizeList(all);\n\n// 8) Captura a query (sem quebrar se nÃ£o existir)\nconst query = safeGetQuery();\n\n// 9) Captura usage da resposta do modelo (input_tokens, output_tokens, total_tokens)\nconst usage_GPT = safeGetUsage();\n\n// 10) Sem dados â†’ erro padrÃ£o\nif (rows.length === 0) {\n  return [{ json: { Erro: 'NÃ£o foram encontrados dados para esta solicitaÃ§Ã£o' } }];\n}\n\n// 11) OK: retorna SEMPRE { data, query } + usage_GTP quando disponÃ­vel\nconst payload = { data: rows, query };\n\nif (usage_GPT && Object.values(usage_GPT).some(v => v !== undefined && v !== null)) {\n  payload.usage_GPT_Query = usage_GPT;\n}\n\nreturn [{ json: payload }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1632,
        224
      ],
      "id": "af6ae451-c9af-42a5-8a14-2f7d1b1197df",
      "name": "Repassar dados"
    },
    {
      "parameters": {
        "jsCode": "// Entrada: { sql: \"SELECT ...\", userPrompt: \"...\" }  (ajuste nomes se preciso)\nlet sql = ($('Extract SQL query').first().json.query || \"\").trim();\n\n// 1) Remove comentÃ¡rios (-- e /* */) e normaliza espaÃ§os\nconst stripComments = s => {\n  // remove /* ... */ (multilinha)\n  s = s.replace(/\\/\\*[\\s\\S]*?\\*\\//g, ' ');\n  // remove -- atÃ© o fim da linha\n  s = s.replace(/--.*$/gm, ' ');\n  return s;\n};\nconst cleaned = stripComments(sql).replace(/\\s+/g, ' ').trim();\n\nconst forbidden = /\\b(SOMENTE|INSERT|UPDATE|DELETE|MERGE|CREATE|ALTER|DROP|TRUNCATE|GRANT|REVOKE|COMMENT|VACUUM|COPY|REFRESH|CALL|DO|BEGIN|COMMIT|ROLLBACK|SET|LOCK|CLUSTER|REINDEX|DISCARD)\\b/i;\nif (forbidden.test(cleaned)) {\n  return [{ \n    allowed: false, \n    reason: \"ContÃ©m comando proibido.\", \n    erro: `Somente SELECT Ã© permitido. NÃ£o posso executar DDL/DML.\n    Detalhes: ` + $input.first().json.output\n  }];\n}\n\nreturn [{ allowed: true, sql }];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -2304,
        128
      ],
      "id": "f585f7fd-44b6-4f6f-ad01-16f1b463259b",
      "name": "Extrair query"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Run Once for Each Item\n// devolve UM item por entrada (sem colchetes)\nconst msg = $json.output; \nreturn {\n  json: {\n      erro:msg ?? \"Por favor, forneÃ§a a consulta ou pergunta especÃ­fica que deseja realizar com base no esquema fornecido.\"\n  }\n};\n\n\n\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1856,
        416
      ],
      "id": "182ec2aa-caa0-41d6-94e1-9fd401fc2418",
      "name": "Mensagem de query invÃ¡lida"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Run Once for Each Item\n/**\n const msg = \"SolicitaÃ§Ã£o contÃ©m comando proibido, somente SELECT Ã© permitido. NÃ£o posso executar DDL/DML.\";\n */\nconst msg = $json.erro;\nreturn {\n  json: { erro: msg }\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1856,
        224
      ],
      "id": "10fe7c06-9980-490c-8e79-1f3e79fe067b",
      "name": "Mensagem de query Proibida"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const item = $input.item;\nconst j = item.json;\n\nconst configuracaoPorCliente = {\n  \"0001\": {\n    host: \"readerweb.crn36nipjstz.us-east-1.rds.amazonaws.com\",\n    database: \"readerweb_0926_teste\",\n    user: \"root\",\n    senha: \"iF9Z!BE4gy\",\n    porta: 3306,\n  },\n  \"3738\": {\n    host: \"readerweb.crn36nipjstz.us-east-1.rds.amazonaws.com\",\n    database: \"readerweb_0926_teste\",\n    user: \"root\",\n    senha: \"iF9Z!BE4gy\",\n    porta: 3306,\n  },\n  \"0962\": {\n    host: \"teste1.imanager.inovamobil.com.br\",\n    database: \"readerweb_0962\",\n    user: \"teste\",\n    senha: \"teste.1234@\",\n    porta: 3306,\n  },\n};\n\n// ==== OBRIGATÃ“RIO TER cÃ³digo do IManager ====\nconst codigoIManager = (j.CodigoIManager ?? \"0962\");\nconst selected = configuracaoPorCliente[codigoIManager];\nif (!selected) {\n  throw new Error(\n    `Cliente ` + codigoIManager + ` nÃ£o informado, favor validar para utilizaÃ§Ã£o do mÃ³dulo.`\n  );\n}\n\nj.configuracao = {\n    host: selected.host,\n    database: selected.database,\n    user: selected.user,\n    password: selected.senha,\n    port: selected.porta,\n  };\n\nreturn item;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -4000,
        224
      ],
      "id": "fbe0d323-80c6-4976-8c54-eb21929a278c",
      "name": "Constantes"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "{{ $json.sql }}",
        "options": {}
      },
      "id": "f8f62505-1f0f-453e-afa3-1db873ce922e",
      "name": "Executar query",
      "type": "n8n-nodes-base.mySql",
      "position": [
        -1856,
        32
      ],
      "typeVersion": 2.4,
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "w2ul7xQhpE4d1ssF",
          "name": "MySQL account"
        }
      },
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// Captura o node \"Combine schema data and chat input\"\nconst combineNode = $('Combine schema data and chat input').first();\nconst pedido = combineNode?.json?.chatinput || '';\n\n// Captura o dataset atual\nconst src = $json.envelope ?? $json;\nconst dataIn = Array.isArray(src?.resultado?.data)\n  ? src.resultado.data\n  : Array.isArray(src?.data)\n  ? src.data\n  : [];\n\n// Normaliza chaves e converte valores numÃ©ricos\nconst normalizeKey = (k) =>\n  k\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n    .replace(/\\s+/g, '_')\n    .replace(/[^\\w]/g, '_')\n    .replace(/_+/g, '_')\n    .replace(/^_|_$/g, '')\n    .toLowerCase();\n\nconst toNumber = (v) =>\n  typeof v === 'string' && /^\\s*\\d+(?:[.,]\\d+)?\\s*$/.test(v)\n    ? Number(v.replace(',', '.'))\n    : v;\n\nconst dataNorm = (dataIn || []).map((row) => {\n  const out = {};\n  for (const [k, v] of Object.entries(row)) {\n    const nk = normalizeKey(k);\n    const nv = toNumber(v);\n    out[nk] = nv;\n    if (!(k in out)) out[k] = nv; // mantÃ©m original tambÃ©m\n  }\n  return out;\n});\n\n// Monta o envelope final para o BILL\nreturn [\n  {\n    json: {\n      envelope: {\n        pedido_cliente: pedido || src.pedido_cliente || 'â€”',\n        resultado: {\n          data: dataNorm,\n          query: src?.resultado?.query || src?.query || '',\n        },\n        metadados: src.metadados || {\n          origem: 'n8n',\n          unidade: 'clientes',\n          moeda: 'BRL',\n        },\n      },\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1168,
        416
      ],
      "id": "19e4ff37-aac2-485a-a3d7-b0ec5c4d7131",
      "name": "Gerar envelope de dados e solicitaÃ§Ã£o"
    },
    {
      "parameters": {
        "jsCode": "// Agora o Merge jÃ¡ trouxe os dois lados num Ãºnico item (json Ãºnico)\nconst M = $json || {};\n\nconst pedido_cliente =$('Combine schema data and chat input').first().json.chatinput;\n  \nconst data =\n  M.data ??\n  M.envelope?.resultado?.data ??\n  null;\n\nconst query =\n  M.query ??\n  M.envelope?.resultado?.query ??\n  null;\n\n// Erros podem ter vindo de Repassar dados\nconst erro  = M.erro ?? M.error ?? null;\nconst erros = Array.isArray(M.Erros) ? M.Erros\n           : Array.isArray(M.erros) ? M.erros\n           : Array.isArray(M.errors) ? M.errors\n           : [];\n\n// A anÃ¡lise pode ter vindo do Analista em vÃ¡rias chaves\nconst diagnostico =$input.first().json[\"DiagnÃ³stico\"];\n\nconst hasError = !!erro || (Array.isArray(erros) && erros.length > 0);\n\nreturn [{\n  json: {\n    pedido_cliente,\n    data,\n    query,\n    erro,\n    erros,\n    diagnostico: hasError ? null : diagnostico,\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -32,
        288
      ],
      "id": "e5dbe3dd-2e8f-494b-8dff-f6f433a8f49b",
      "name": "Unificar Resultado",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "5787e004-2bc5-4530-8e20-cea5b52f05ef",
              "leftValue": "={{ !!(\n  $json.Erro\n    ? (Array.isArray($json.Erro)\n        ? $json.Erro.length > 0\n        : String($json.Erro).trim() !== '')\n    : false\n) }}",
              "rightValue": 0,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1408,
        352
      ],
      "id": "4229560a-d77b-49fd-856a-a03402d9f308",
      "name": "Gerou algum erro ?"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Here is the database schema: {{ $json.schema }}\nHere is the user request: {{ $json.chatinput }}",
        "options": {
          "systemMessage": "VocÃª Ã© um gerador de SQL para MySQL 8.0+, guiado por um JSON chamado SCHEMA.\nSeu objetivo Ã© gerar apenas consultas SELECT 100% vÃ¡lidas e coerentes com o SCHEMA.\nNunca produza instruÃ§Ãµes que criem, alterem, excluam ou modifiquem dados.\n\nO SCHEMA Ã© fornecido em formato JSON nesta conversa e contÃ©m:\n\ntabelas, colunas, tipos, chaves e relacionamentos;\n\nmetadados (meta.deduplication, meta.month_reference, meta.pivot, meta.role, meta_class);\n\npolÃ­ticas de geraÃ§Ã£o (generator_policies) e normalizaÃ§Ã£o de termos de negÃ³cio.\n\nSempre que houver conflito entre uma regra genÃ©rica e algo explÃ­cito no SCHEMA, siga o SCHEMA.\n\nâš™ï¸ CONFIGURAÃ‡Ã•ES DE DIALETO E FORMATAÃ‡ÃƒO\n\nDialeto: MySQL 8.0+\n\nIdentificadores (tabelas e colunas): sempre entre crases â†’ ...\nStrings: entre aspas simples â†’ 'texto'\n\nProibido:\n\nAspas duplas (\"...\")\n\nPrefixos de schema (ex.: public.)\n\nPonto e vÃ­rgula (;) ao final da query\n\nCase: respeitar exatamente o case do SCHEMA.\nSeparador decimal: ponto â€œ.â€.\nPalavras reservadas sÃ³ podem ser usadas como identificadores se estiverem entre crases.\n\nMySQL 8 NÃƒO possui o operador ILIKE.\nNunca use ILIKE em nenhuma situaÃ§Ã£o.\nSe em qualquer momento vocÃª gerar ILIKE, considere a query invÃ¡lida e regenere a SQL substituindo por LIKE com COLLATE ou usando LOWER(coluna) LIKE padrÃ£o.\nSe precisar de comparaÃ§Ã£o case-insensitive, use:\n\nLOWER(coluna) LIKE 'padrÃ£o', ou\n\ncoluna COLLATE <collation> LIKE 'padrÃ£o', se o SCHEMA indicar a collation.\n\nğŸ”’ POLÃTICA DE SEGURANÃ‡A\n\nSomente SELECT Ã© permitido.\nNÃ£o posso criar, alterar, inserir ou deletar.\nReescreva qualquer pedido como um SELECT.\n\nComandos proibidos:\nINSERT, UPDATE, DELETE, MERGE, CREATE, ALTER, DROP, TRUNCATE,\nGRANT, REVOKE, COMMENT, VACUUM, COPY, REFRESH, CALL, DO, BEGIN,\nCOMMIT, ROLLBACK, SET, LOCK, CLUSTER, REINDEX, DISCARD.\n\nSe o usuÃ¡rio pedir algo que envolva qualquer comando acima, responda somente com:\n\nâŒ Somente SELECT Ã© permitido. NÃ£o posso criar, alterar, inserir ou deletar. Reescreva seu pedido como um SELECT.\n\nğŸ§© REGRAS DE USO DO SCHEMA\n\nSÃ³ use colunas e tabelas que existem no SCHEMA JSON.\n\nRespeite os tipos, nomes e cases definidos.\n\nUse apenas relacionamentos descritos no SCHEMA (relacionamentos, meta.join_hint, meta.lookup).\n\nSe o campo solicitado nÃ£o existir e nÃ£o houver nenhum alias configurado para ele, responda:\n\nâŒ NÃ£o Ã© possÃ­vel gerar a consulta porque o campo nÃ£o existe no SCHEMA.\n\nğŸ§  INTERPRETAÃ‡ÃƒO EM LINGUAGEM DE NEGÃ“CIO\n\nO usuÃ¡rio sempre fala em linguagem de negÃ³cio, por exemplo:\nâ€œleituristaâ€, â€œocorrÃªnciaâ€, â€œreferÃªncia 09/2025â€, â€œclientes com corteâ€, â€œconsumoâ€, â€œhidrometroâ€, â€œnÃ­velâ€, â€œcategoriaâ€, â€œUCâ€, â€œunidade consumidoraâ€, â€œmatrÃ­culaâ€, â€œligaÃ§Ã£oâ€, etc.\n\nAntes de montar o SQL, faÃ§a internamente (sem imprimir) este fluxo:\n\nNormalize os termos de negÃ³cio usando, nesta ordem:\n\nSCHEMA.policy.terminology_normalization\n(ex.: â€œmedidorâ€ â†’ â€œhidrometroâ€; â€œnÃ­vel/nivelâ€ â†’ â€œcategoriaâ€;\nâ€œUCâ€, â€œunidade consumidoraâ€, â€œmatrÃ­cula/matriculaâ€, â€œligaÃ§Ã£o/ligacaoâ€ â†’ â€œclienteâ€)\n\nSCHEMA.generator_policies.column_aliases\nExemplos tÃ­picos (dependem do SCHEMA real):\n\nâ€œmatrÃ­culaâ€, â€œcÃ³digo da ligaÃ§Ã£oâ€ â†’ CodigoMatriculaCliente\n\nâ€œocorrÃªnciaâ€, â€œcÃ³digo da ocorrÃªnciaâ€ â†’ coluna de ocorrÃªncia configurada (por exemplo CodigoOcorrenciaAtual em vcliente)\n\nâ€œdescriÃ§Ã£o da ocorrÃªnciaâ€ â†’ coluna de descriÃ§Ã£o de ocorrÃªncia (ex.: DescricaoOcorrÃªncia)\n\nâ€œtipo de serviÃ§oâ€, â€œserviÃ§oâ€ â†’ campo de tipo de serviÃ§o na tabela de serviÃ§os\n\nâ€œlocalizaÃ§Ã£o do hidrÃ´metroâ€ â†’ campo de localizaÃ§Ã£o do hidrÃ´metro\n\ndescriÃ§Ãµes das colunas em tabelas[colunas].descricao, quando necessÃ¡rio.\n\nIdentifique a intenÃ§Ã£o:\n\nentidade principal: cliente, leiturista, ocorrÃªncia, serviÃ§o, categoria, setor, rota, etc.\n\nmÃ©trica: contagem de ocorrÃªncias, soma de consumo, mÃ©dia de valor, quantidade de serviÃ§os, ranking, comparaÃ§Ã£o entre meses, etc.\n\nperÃ­odo/referÃªncia: por exemplo â€œ09/2025â€, â€œ10/2025â€, â€œÃºltimos 3 mesesâ€.\n\nfiltros adicionais: tipo de ocorrÃªncia, tipo de serviÃ§o, bairro, rota, categoria, situaÃ§Ã£o de corte/retenÃ§Ã£o, localizaÃ§Ã£o do hidrÃ´metro, etc.\n\nReferÃªncia / MesAnoReferÃªncia (campo string MM/YYYY)\n\nMesAnoReferÃªncia Ã© uma string no formato MM/YYYY.\n\nSempre que precisar comparar por tempo ou identificar a referÃªncia mais recente, converta para data usando a expressÃ£o definida em month_reference.to_date_expr, por exemplo:\n\nSTR_TO_DATE(CONCAT('01/', MesAnoReferÃªncia), '%d/%m/%Y')\n\n\nSe o usuÃ¡rio informar explicitamente a referÃªncia (ex.: â€œna referÃªncia 10/2025â€), use exatamente essa string no filtro:\n\nWHERE c.`MesAnoReferÃªncia` = '10/2025'\n\n\nSe o usuÃ¡rio NÃƒO informar nenhuma referÃªncia, mÃªs ou perÃ­odo e a consulta envolver vcliente (dados por referÃªncia):\n\nUse sempre a Ãºltima referÃªncia disponÃ­vel na base, utilizando a expressÃ£o configurada em generator_policies.default_reference.sql_expr, equivalente a:\n\n(\n  SELECT vc.`MesAnoReferÃªncia`\n  FROM `vcliente` vc\n  WHERE vc.`MesAnoReferÃªncia` IS NOT NULL\n    AND vc.`MesAnoReferÃªncia` <> ''\n  ORDER BY STR_TO_DATE(CONCAT('01/', vc.`MesAnoReferÃªncia`), '%d/%m/%Y') DESC\n  LIMIT 1\n)\n\n\nExemplo de uso:\n\nWHERE c.`MesAnoReferÃªncia` = (\n  SELECT vc.`MesAnoReferÃªncia`\n  FROM `vcliente` vc\n  WHERE vc.`MesAnoReferÃªncia` IS NOT NULL\n    AND vc.`MesAnoReferÃªncia` <> ''\n  ORDER BY STR_TO_DATE(CONCAT('01/', vc.`MesAnoReferÃªncia`), '%d/%m/%Y') DESC\n  LIMIT 1\n)\n\n\nNunca gere consultas em vcliente sem filtro de referÃªncia quando for possÃ­vel restringir Ã  Ãºltima referÃªncia, a menos que o usuÃ¡rio peÃ§a explicitamente â€œtodas as referÃªnciasâ€ ou um intervalo claro.\n\nEscolha as tabelas de origem de acordo com o SCHEMA:\n\nUse vcliente como visÃ£o principal de dados por referÃªncia (cliente, consumo, valores, ocorrÃªncia atual, rota, setor, categoria, economias, status de retenÃ§Ã£o, etc.).\n\nUse a(s) tabela(s) de serviÃ§os (por exemplo vserviÃ§os) quando o foco for serviÃ§os executados/lanÃ§ados, ligando Ã  vcliente pelos campos configurados (geralmente CodigoMatriculaCliente e NomeArquivo, e quando aplicÃ¡vel MesAnoReferÃªncia).\n\nUse int_leiturista e/ou tabelas de log (ex.: mob_log) para detalhes adicionais de leituristas.\n\nUse tabelas de domÃ­nio (tipos de cÃ¡lculo, tipos de cobranÃ§a, status de retenÃ§Ã£o, localizaÃ§Ã£o de hidrÃ´metro, tipos de serviÃ§o, categorias, etc.) quando o usuÃ¡rio falar em descriÃ§Ãµes.\n\nSÃ³ depois disso monte o SELECT, com:\n\nFROM e JOIN baseados em relacionamentos, meta.lookup, meta.join_hints.\n\nWHERE com filtros de referÃªncia/perÃ­odo, usando:\n\no valor informado pelo usuÃ¡rio, ou\n\na expressÃ£o da Ãºltima referÃªncia quando o usuÃ¡rio nÃ£o informar nada.\n\nGROUP BY e ORDER BY compatÃ­veis com a mÃ©trica desejada.\n\nğŸ” USO DE METADADOS DO SCHEMA\n\nO SCHEMA JSON pode conter:\n\nmeta.deduplication\n\nmeta.month_reference\n\nmeta.pivot\n\nmeta.role\n\nmeta_class (por exemplo \"analytical_view\")\n\nSempre que esses metadados estiverem presentes e forem relevantes:\n\nDeduplicaÃ§Ã£o\n\nSe meta.deduplication estiver definido (por exemplo, em vcliente ou vhistÃ³ricodeleitura):\n\nselecione apenas a linha mais recente por combinaÃ§Ã£o de campos em partition_by\n(geralmente algo como CodigoMatriculaCliente + MesAnoReferÃªncia),\n\nusando ROW_NUMBER() ou janela equivalente, com ORDER BY definido (por exemplo Sequencia ou OrdenacÃ£o DESC),\n\nsem usar agregaÃ§Ãµes numÃ©ricas (SUM/AVG/COUNT) para eliminar duplicidade.\n\nPivot / comparaÃ§Ãµes multi-mÃªs\n\nQuando o pedido envolver duas ou mais referÃªncias de mÃªs/ano e o SCHEMA tiver meta.pivot, use essa definiÃ§Ã£o para montar um pivot emulado:\n\nÃ­ndice: pivot.index (ex.: CodigoMatriculaCliente)\n\ncolunas: pivot.columns (ex.: MesAnoReferÃªncia)\n\nvalores: apenas campos em pivot.value_fields, quando aplicÃ¡vel\n\nNunca use a palavra-chave PIVOT/UNPIVOT (MySQL 8 nÃ£o possui).\n\nEm vez disso, use CTE + JOIN entre CTEs por cÃ³digo do cliente, garantindo deduplicaÃ§Ã£o por mÃªs antes da junÃ§Ã£o.\n\nViews analÃ­ticas\n\nSe meta_class = \"analytical_view\", trate a tabela como visÃ£o de anÃ¡lise temporal, aplicando deduplicaÃ§Ã£o e regras de referÃªncia de forma consistente.\n\nğŸ§­ OCORRÃŠNCIAS (REGRAS ESPECÃFICAS)\n\nSÃ³ use campos de ocorrÃªncia (`CodigoOcorrenciaAtual`, tabelas de ocorrÃªncia como `mis_ocorrencia`, descriÃ§Ãµes de ocorrÃªncia)\nquando a pergunta falar explicitamente em ocorrÃªncia/ocorrÃªncias, cÃ³digos de ocorrÃªncia ou anÃ¡lise de ocorrÃªncia.\n\nSe a pergunta NÃƒO citar ocorrÃªncia (por exemplo, perguntas sobre â€œleituras realizadasâ€, â€œclientes visitadosâ€, â€œprodutividade de leituraâ€\nou â€œquem leu mais em determinada referÃªnciaâ€), NÃƒO use `CodigoOcorrenciaAtual` nem faÃ§a JOIN ou subconsulta em `mis_ocorrencia`.\nNesses casos, baseie-se apenas em `Visitado = 'S'` e nos demais campos de leitura definidos no SCHEMA.\n\nQuando a consulta envolver claramente â€œocorrÃªnciasâ€ e for necessÃ¡rio desconsiderar â€œLeitura normalâ€ e â€œsem ocorrÃªnciaâ€, utilize a polÃ­tica de exclusÃ£o\nde ocorrÃªncia definida no SCHEMA (policy.occurrence_exclusion e filters.occurrence_exclusions), sem transformar isso em regra padrÃ£o para todas as consultas.\nInterprete essas polÃ­ticas como um recurso OPCIONAL, aplicado somente em queries cujo objetivo seja analisar ocorrÃªncias.\nNÃ£o copie cegamente blocos de SQL prontos de exemplos: construa a condiÃ§Ã£o de exclusÃ£o de acordo com o SCHEMA e com a intenÃ§Ã£o explÃ­cita da pergunta.\n\nAntes de usar qualquer campo de ocorrÃªncia (como `CodigoOcorrenciaAtual` ou a tabela `mis_ocorrencia`), verifique se o usuÃ¡rio\nfalou explicitamente em â€œocorrÃªnciaâ€, â€œocorrÃªnciasâ€, â€œcÃ³digo de ocorrÃªnciaâ€ ou anÃ¡lise de ocorrÃªncia.\nSe a pergunta for sobre â€œleituras realizadasâ€, â€œleituras executadasâ€, â€œclientes visitadosâ€, â€œprodutividade de leituraâ€, â€œquantidade de leiturasâ€\nou temas semelhantes, Ã© PROIBIDO usar `CodigoOcorrenciaAtual` ou `mis_ocorrencia`. Nesses casos, use apenas `Visitado = 'S'` ou outros campos de leitura definidos no SCHEMA.\n\n\nğŸ§® COMPORTAMENTO GERAL\n\nGere apenas SELECTs legÃ­veis e vÃ¡lidos para MySQL 8.0+.\n\nRespeite o SCHEMA, seus metadados e polÃ­ticas de geraÃ§Ã£o.\n\nPode usar agregaÃ§Ãµes (SUM, AVG, COUNT, MAX, MIN, etc.) e WHERE, GROUP BY, ORDER BY, LIMIT, desde que:\n\nnÃ£o sejam usadas para mascarar duplicidade que deveria ser resolvida por deduplicaÃ§Ã£o (ROW_NUMBER / subconsulta)\n\nnÃ£o violem allow_numeric_aggregation=false quando definido no SCHEMA.\n\nQuando a consulta envolver duas ou mais referÃªncias na mesma entidade (por exemplo, comparaÃ§Ã£o de leituras entre 08/2025 e 09/2025 na prÃ³pria vcliente), use apenas as chaves de join recomendadas (por exemplo, CodigoMatriculaCliente), evitando colunas que variam de mÃªs a mÃªs, como NomeArquivo, salvo se o SCHEMA indicar explicitamente o contrÃ¡rio.\n\nğŸ“¤ SAÃDA\n\nRetorne apenas o SQL final, sem explicaÃ§Ãµes, sem comentÃ¡rios e sem ponto e vÃ­rgula no fim.",
          "maxIterations": 1,
          "returnIntermediateSteps": true
        }
      },
      "id": "6267fe6d-79af-4450-a09b-004ab4b26e13",
      "name": "Gerador de Query",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -3104,
        224
      ],
      "typeVersion": 1.6
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={\n  \"pedido_cliente\": \"{{$json.envelope.pedido_cliente}}\",\n  \"resultado\": {\n    \"data\": {{ JSON.stringify($json.envelope.resultado.data) }},\n    \"query\": \"{{$json.envelope.resultado.query}}\"\n  },\n  \"metadados\": {{ JSON.stringify($json.envelope.metadados) }}\n}",
        "options": {
          "systemMessage": "â¦ƒ\nVocÃª Ã© BILL, consultor tÃ©cnico e estratÃ©gico em saneamento. Analise pedido_cliente e resultado.data e produza somente um JSON vÃ¡lido, sem texto fora dele. Use exclusivamente resultado.data; nÃ£o invente nÃºmeros.\n\nSe houver atÃ© 3 valores relevantes, seja direto; se houver mais, detalhe. Percentuais usam â€œ%â€ e valores â€œR$xx.xxâ€. NÃ£o use separador de milhar.\n\nEstrutura obrigatÃ³ria:\nâ¦ƒ\n\"ğŸ§­ contexto\": \"Compare com benchmarks do setor (SNIS 2023, ANA, Trata Brasil, reguladoras). Indique se estÃ¡ melhor, pior ou similar.\",\n\n\"ğŸ“ˆ indicadores\": â¦ƒ\n\"ğŸ“ descriÃ§Ã£o\": \"Explique o formato do dataset (linha Ãºnica ou mÃºltiplos registros por leiturista, categoria, mÃªs, ocorrÃªncia etc.). Use todos os nÃºmeros disponÃ­veis, identificando variaÃ§Ãµes quando houver datas (_MM_AAAA).\",\n\"ğŸ”¢ valores\": â¦ƒ\n\"principais_mÃ©tricas\": \"Liste totais, mÃ©dias, variaÃ§Ãµes, percentuais e rankings com nomes reais dos campos, detalhando por leiturista, ocorrÃªncia, rota, bairro ou categoria quando existirem.\",\n\"resumo_quantitativo\": \"Resuma valores e percentuais (duas casas), classificando %: atÃ© 10 baixa; 10â€“20 moderada; 20â€“30 elevada; acima de 30 crÃ­tica. Reutilize exatamente os mesmos nÃºmeros de principais_mÃ©tricas.\"\nâ¦„\nâ¦„,\n\n\"ğŸ“‹ anÃ¡lise_interpretativa\": \"Interprete os nÃºmeros: melhora, piora, estabilidade, concentraÃ§Ã£o de problemas ou ganhos; compare grupos e explique o significado tÃ©cnico (ex.: maior percentual de ocorrÃªncia ou maior faturamento).\",\n\n\"ğŸ§¾ descriÃ§Ã£o\": \"DiagnÃ³stico tÃ©cnico direto, baseado nos nÃºmeros, relacionando causas/efeitos tÃ­picos (micromediÃ§Ã£o, perdas, leitura, faturamento, cadastro).\",\n\n\"âš™ï¸ aÃ§Ãµes\": [\"AÃ§Ãµes objetivas ligadas aos dados: auditorias, revisÃµes cadastrais, vistorias, troca de hidrÃ´metros, ajustes de rotas, melhorias de leitura ou comunicaÃ§Ã£o.\"],\n\n\"ğŸ§· resumo_consultivo\": \"ConclusÃ£o executiva (atÃ© 5 linhas) integrando nÃºmeros e recomendaÃ§Ãµes; destaque gravidade (%) e impacto potencial (R$).\"\nâ¦„\n\nRegras numÃ©ricas:\n\nUse apenas valores de resultado.data.\n\nEm resumo_quantitativo, nunca contradiga principais_mÃ©tricas.\n\nSe um total nÃ£o puder ser consolidado, diga que a consolidaÃ§Ã£o nÃ£o Ã© segura.\n\nSempre use â€œ%â€ para percentuais e â€œR$â€ para valores.\n\nCasos de leitura e ocorrÃªncia:\nâ€¢ Se houver leituristas: calcular total de leituras, leituras com ocorrÃªncia e percentual (duas casas, %).\nâ€¢ Se houver tipos de ocorrÃªncia: identificar as 2 ou 3 mais frequentes e citÃ¡-las.\nâ€¢ Garantir coerÃªncia entre totais e percentuais.\n\nSe resultado.data estiver vazio, retorne exatamente:\nâ¦ƒ\n\"ğŸ§­ contexto\": \"â€”\",\n\"ğŸ“ˆ indicadores\": \"â€”\",\n\"ğŸ§¾ descriÃ§Ã£o\": \"â€”\",\n\"ğŸ“‹ anÃ¡lise_interpretativa\": \"-\",\n\"âš™ï¸ aÃ§Ãµes\": [],\n\"ğŸ§· resumo_consultivo\": \"NÃ£o hÃ¡ dados suficientes para anÃ¡lise.\"\nâ¦„\nâ¦„",
          "maxIterations": 5,
          "returnIntermediateSteps": true
        }
      },
      "id": "ba7b807b-425e-4f27-888d-aad4d91ec093",
      "name": "Analista de Dados",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "position": [
        -960,
        352
      ],
      "typeVersion": 1.6
    },
    {
      "parameters": {
        "model": "gpt-5-mini",
        "options": {
          "maxTokens": "***MASKED_SECRET***",
          "maxRetries": 3
        }
      },
      "id": "c8e48603-4bad-4eba-b8f1-0f8b83e0d442",
      "name": "OpenAI Chat Model gerador de Query",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        -3216,
        432
      ],
      "typeVersion": 1,
      "credentials": {
        "openAiApi": {
          "id": "H4HnbIJCN7JE8cR5",
          "name": "OpenAi datamobil_Reader"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "***MASKED_SECRET***",
        "contextWindowLength": 1
      },
      "id": "b8ade3ae-4dd3-4eab-b52f-a059176150bb",
      "name": "Window Buffer Memory Analista de dados",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        -912,
        592
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "model": "gpt-5-mini",
        "options": {
          "maxTokens": "***MASKED_SECRET***",
          "maxRetries": 2
        }
      },
      "id": "008ce5de-4a78-4736-bea6-c8f0f719d8da",
      "name": "OpenAI Chat Model Analista de dados",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "position": [
        -1056,
        592
      ],
      "typeVersion": 1,
      "credentials": {
        "openAiApi": {
          "id": "H4HnbIJCN7JE8cR5",
          "name": "OpenAi datamobil_Reader"
        }
      }
    },
    {
      "parameters": {},
      "id": "a5c5adc6-bed6-4ae8-9d0d-7292b1c65397",
      "name": "MemÃ³ria gerador de query",
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "position": [
        -3040,
        432
      ],
      "typeVersion": 1.2
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -432,
        176
      ],
      "id": "d2beef28-4e98-4826-9a35-194849ab4a28",
      "name": "Unificar saidas"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "5787e004-2bc5-4530-8e20-cea5b52f05ef",
              "leftValue": "={{ $json.Erro.length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -240,
        176
      ],
      "id": "fd77362d-b296-441a-a62b-17481db3e574",
      "name": "Gerou algum erro ?1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        0,
        0
      ],
      "id": "1539f3d7-e6a8-4550-a806-31a080ee6ff7",
      "name": "Respond to Webhook1"
    },
    {
      "parameters": {
        "jsCode": "// === 1. CAPTURA DO BRUTO VINDO DO AGENT ===\nconst steps = $json.intermediateSteps ?? [];\n\nlet raw =\n  (steps.length\n    ? (\n        steps[steps.length - 1].output\n        ?? steps[steps.length - 1].toolOutput\n        ?? steps[steps.length - 1].result\n      )\n    : null\n  )\n  ?? $json.output\n  ?? $json.text\n  ?? $json.response\n  ?? \"\";\n\n// Se jÃ¡ vier objeto, Ã³timo, nÃ£o precisa parsear string\nlet obj;\nif (raw && typeof raw === \"object\") {\n  obj = raw;\n} else {\n  // forÃ§a string\n  raw = String(raw).trim()\n    // remove ```json ... ``` se vier\n    .replace(/^```(?:json)?\\s*/i, \"\")\n    .replace(/\\s*```$/i, \"\");\n\n  // se for string JSON dentro de string (aspas por fora), tenta desserializar uma vez\n  if (\n    (raw.startsWith('\"') && raw.endsWith('\"')) ||\n    (raw.startsWith(\"'\") && raw.endsWith(\"'\"))\n  ) {\n    try { raw = JSON.parse(raw); } catch {}\n  }\n\n  // se ainda for string, tenta extrair o primeiro bloco { ... }\n  if (typeof raw === \"string\") {\n    const m = raw.match(/\\{[\\s\\S]*\\}/m);\n    if (m) raw = m[0];\n  }\n\n  // === 2. FUNÃ‡ÃƒO DE PARSE COM HEURÃSTICA + NORMALIZAÃ‡ÃƒO ===\n  function tryParseWithBraceHeuristic(str) {\n    if (typeof str !== \"string\") return str;\n\n    // 2.1 normalizar escapes comuns gerados pelo modelo (\\n, \\t)\n    str = str.replace(/\\\\n/g, '\\n').replace(/\\\\t/g, '\\t');\n\n    // 2.2 normalizar nÃºmeros com separador de milhar do tipo \": 2,570\"\n    // Ex.: \"total_leituras\\\": 2,570,\"  =>  \"total_leituras\\\": 2570,\"\n    // PadrÃ£o: \":\" + espaÃ§os + atÃ© 3 dÃ­gitos + \",\" + 3 dÃ­gitos + (\",\" ou \"}\")\n    str = str.replace(\n      /(:\\s*)(-?\\d{1,3}),(\\d{3})(\\s*[,\\}])/g,\n      (_, prefixo, milhar, centena, sufixo) => `${prefixo}${milhar}${centena}${sufixo}`\n    );\n\n    // 2.3 tenta JSON.parse direto\n    try {\n      return JSON.parse(str);\n    } catch (e1) {\n      // 2.4 heurÃ­stica de balanceamento de chaves\n      let depth = 0;\n      let inString = false;\n      let escape = false;\n      let lastCompleteIndex = -1;\n\n      for (let i = 0; i < str.length; i++) {\n        const ch = str[i];\n\n        if (escape) {\n          escape = false;\n          continue;\n        }\n        if (ch === '\\\\') {\n          escape = true;\n          continue;\n        }\n        if (ch === '\"' && !escape) {\n          inString = !inString;\n          continue;\n        }\n        if (inString) continue;\n\n        if (ch === '{') {\n          depth++;\n        } else if (ch === '}') {\n          depth--;\n          if (depth === 0) {\n            lastCompleteIndex = i;\n          }\n        }\n      }\n\n      if (lastCompleteIndex > -1) {\n        const candidate = str.slice(0, lastCompleteIndex + 1);\n        return JSON.parse(candidate);\n      } else {\n        throw e1;\n      }\n    }\n  }\n\n  let parsed;\n  try {\n    parsed = tryParseWithBraceHeuristic(raw);\n  } catch (eFinal) {\n    // se der ruim, devolve erro explicando\n    return [{\n      json: {\n        DiagnÃ³stico: {\n          erro: \"Falha ao parsear JSON do Agent (mesmo apÃ³s tentativa de reparo por chaves balanceadas e normalizaÃ§Ã£o de nÃºmeros)\",\n          detalhe: String(eFinal),\n          amostra: String(raw).slice(0, 500)\n        }\n      }\n    }];\n  }\n\n  obj = parsed;\n}\n\n// === 3. MAPA DE RENOMEAÃ‡ÃƒO (sem emoji -> com emoji) ===\n\nconst map = {\n   \"ğŸ§­contexto\": \"ğŸ§­ contexto\",\n  \"contexto\": \"contexto\",\n  \"ğŸ“ˆ indicadores\": \"ğŸ“ˆ indicadores\",\n  \"indicadores\": \"ğŸ“ˆ indicadores\",\n  \"ğŸ“ descriÃ§Ã£o\": \"ğŸ“ descriÃ§Ã£o\",\n  \"descricao\": \"ğŸ§¾ descriÃ§Ã£o\",\n  \"descriÃ§Ã£o\": \"ğŸ§¾ descriÃ§Ã£o\",\n  \"ğŸ§¾ descricao\": \"ğŸ§¾ descriÃ§Ã£o\",\n  \"valores\": \"ğŸ”¢ valores\",\n  \"ğŸ”¢ valores\": \"ğŸ”¢ valores\",\n    \"acoes\": \"âš™ï¸ aÃ§Ãµes\",\n  \"aÃ§Ãµes\": \"âš™ï¸ aÃ§Ãµes\",\n  \"âš™ï¸ acoes\": \"âš™ï¸ aÃ§Ãµes\",\n  \"resumo_consultivo\": \"ğŸ§· resumo_consultivo\"\n};\n\nfunction renameKeys(o) {\n  if (o == null || typeof o !== \"object\") return o;\n\n  const out = {};\n  for (const [k, v] of Object.entries(o)) {\n    const nk = map[k] ?? k;\n    out[nk] = v;\n  }\n\n  // Ajusta sub-bloco de indicadores\n  if (out[\"ğŸ“ˆ indicadores\"] && typeof out[\"ğŸ“ˆ indicadores\"] === \"object\") {\n    const ind = out[\"ğŸ“ˆ indicadores\"];\n    const indOut = {};\n    for (const [k, v] of Object.entries(ind)) {\n      const nk = map[k] ?? k;\n      indOut[nk] = v;\n    }\n    out[\"ğŸ“ˆ indicadores\"] = indOut;\n  }\n\n  return out;\n}\n\nconst withEmoji = renameKeys(obj);\n\n// === 4. RETORNO FINAL ENVELOPADO ===\nreturn [{\n  json: {\n    DiagnÃ³stico: withEmoji\n  }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        368
      ],
      "id": "9269de3a-5f7b-4185-8e27-1b5a9aa49ea7",
      "name": "Formatar retorno GPT"
    },
    {
      "parameters": {
        "public": true,
        "initialMessages": "Em que posso lhe ajudar hoje ???",
        "options": {
          "subtitle": "",
          "title": "OlÃ¡, sou o Datamobil ğŸ“ˆ âœ…",
          "customCss": ":root {\n  /* Paleta no estilo Datamobil */\n  --chat--color-primary: #00a0e3;              /* azul do botÃ£o/bolha do usuÃ¡rio */\n  --chat--color-primary-shade-50: #008fd0;\n  --chat--color-primary-shade-100: #0073ad;\n  --chat--color-secondary: #20b69e;\n  --chat--color-secondary-shade-50: #1ca08a;\n\n  /* Evitando branco puro: off-white e cinzas */\n  --chat--color-white: #fdfdfd;                /* quase branco para bolhas/cartÃµes */\n  --chat--color-light: #f3f4f7;                /* FUNDO do chat â€“ cinza da tela */\n  --chat--color-light-shade-50: #e3e7f0;\n  --chat--color-light-shade-100: #c7cedd;\n  --chat--color-medium: #d3d8e4;\n  --chat--color-dark: #101330;\n  --chat--color-disabled: #9aa0b5;\n  --chat--color-typing: #555555;\n\n  /* Base Layout */\n  --chat--spacing: 1rem;\n  --chat--border-radius: 1.5rem;              /* bolhas arredondadas como na imagem */\n  --chat--transition-duration: 0.15s;\n  --chat--font-family: (\n    -apple-system,\n    BlinkMacSystemFont,\n    'Segoe UI',\n    Roboto,\n    Oxygen-Sans,\n    Ubuntu,\n    Cantarell,\n    'Helvetica Neue',\n    sans-serif\n  );\n\n  /* Janela do chat */\n  --chat--window--width: 420px;\n  --chat--window--height: 620px;\n  --chat--window--bottom: var(--chat--spacing);\n  --chat--window--right: var(--chat--spacing);\n  --chat--window--z-index: 9999;\n  --chat--window--border: 1px solid var(--chat--color-light-shade-50);\n  --chat--window--border-radius: 0;           /* retinho, como o container da tela */\n  --chat--window--margin-bottom: var(--chat--spacing);\n\n  /* Header â€“ faixa clara, texto escuro */\n  --chat--header-height: auto;\n  --chat--header--padding: 0.75rem 1.5rem;\n  --chat--header--background: #f7f8fb;        /* quase branco, mas levemente cinza */\n  --chat--header--color: var(--chat--color-dark);\n  --chat--header--border-top: none;\n  --chat--header--border-bottom: 1px solid var(--chat--color-light-shade-50);\n  --chat--header--border-left: none;\n  --chat--header--border-right: none;\n  --chat--heading--font-size: 1.6em;\n  --chat--subtitle--font-size: 0.9em;\n  --chat--subtitle--line-height: 1.4;\n\n  /* Mensagens */\n  --chat--message--font-size: 0.95rem;\n  --chat--message--padding: 0.75rem 1.2rem;\n  --chat--message--border-radius: var(--chat--border-radius);\n  --chat--message-line-height: 1.5;\n  --chat--message--margin-bottom: calc(var(--chat--spacing) * 0.75);\n\n  /* Bot: cartÃ£o off-white no fundo cinza */\n  --chat--message--bot--background: var(--chat--color-white);\n  --chat--message--bot--color: var(--chat--color-dark);\n  --chat--message--bot--border: 1px solid var(--chat--color-light-shade-50);\n\n  /* User: bolha azul como na captura */\n  --chat--message--user--background: var(--chat--color-primary);\n  --chat--message--user--color: #fefefe;\n  --chat--message--user--border: none;\n\n  --chat--message--pre--background: rgba(0, 0, 0, 0.03);\n  --chat--messages-list--padding: 1.5rem 2rem;\n\n  /* BotÃ£o flutuante */\n  --chat--toggle--size: 64px;\n  --chat--toggle--width: var(--chat--toggle--size);\n  --chat--toggle--height: var(--chat--toggle--size);\n  --chat--toggle--border-radius: 50%;\n  --chat--toggle--background: var(--chat--color-primary);\n  --chat--toggle--hover--background: var(--chat--color-primary-shade-50);\n  --chat--toggle--active--background: var(--chat--color-primary-shade-100);\n  --chat--toggle--color: #ffffff;\n\n  /* Input â€“ barra clara, borda azul, como na imagem */\n  --chat--textarea--height: 52px;\n  --chat--textarea--max-height: 30rem;\n  --chat--input--font-size: 0.95rem;\n  --chat--input--border: 1px solid #b9d9f2;\n  --chat--input--border-radius: 999px;\n  --chat--input--padding: 0.75rem 1rem;\n  --chat--input--background: #f7f8fb;\n  --chat--input--text-color: var(--chat--color-dark);\n  --chat--input--line-height: 1.4;\n  --chat--input--placeholder--font-size: var(--chat--input--font-size);\n  --chat--input--border-active: 1px solid var(--chat--color-primary);\n  --chat--input--left--panel--width: 2rem;\n\n  /* BotÃµes internos */\n  --chat--button--color: #fefefe;\n  --chat--button--background: var(--chat--color-primary);\n  --chat--button--padding: calc(var(--chat--spacing) * 0.5) var(--chat--spacing);\n  --chat--button--border-radius: 999px;\n  --chat--button--hover--color: #fefefe;\n  --chat--button--hover--background: var(--chat--color-primary-shade-50);\n  --chat--close--button--color-hover: var(--chat--color-primary);\n\n  /* BotÃµes de enviar/anexo (cores) */\n  --chat--input--send--button--background: var(--chat--color-primary);\n  --chat--input--send--button--color: #fefefe;\n  --chat--input--send--button--background-hover: var(--chat--color-primary-shade-50);\n  --chat--input--send--button--color-hover: #fefefe;\n  --chat--input--file--button--background: transparent;\n  --chat--input--file--button--color: var(--chat--color-secondary);\n  --chat--input--file--button--background-hover: transparent;\n  --chat--input--file--button--color-hover: var(--chat--color-secondary-shade-50);\n  --chat--files-spacing: 0.25rem;\n\n  /* Body e footer â€“ FUNDO CINZA como na imagem */\n  --chat--body--background: var(--chat--color-light);\n  --chat--footer--background: var(--chat--color-light);\n  --chat--footer--color: var(--chat--color-dark);\n}\n\n/* Bolhas no estilo Datamobil */\n.chat-message {\n  max-width: 50%;\n  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);\n}\n\n/* Alinhamento: usuÃ¡rio Ã  direita, bot Ã  esquerda */\n.chat-message--user {\n  margin-left: auto;\n}\n\n.chat-message--bot {\n  margin-right: auto;\n}\n\n/* Centraliza apenas a PRIMEIRA mensagem do bot\n   (ex: \"Boa tarde !!! Sou o Datamobil ğŸ“ˆ\") */\n.chat-messages-list .chat-message--bot:first-child {\n  display: flex;\n  justify-content: center;\n  text-align: center;\n}\n\n/* === BOTÃƒO DE ENVIAR MAIS ARREDONDADO (ESTILO FAB) === */\n/* Ajuste o seletor abaixo para a classe real do botÃ£o de enviar, se for diferente */\n.chat-input__send-button {\n  width: 44px;\n  height: 44px;\n  border-radius: 50%;\n  padding: 0;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  box-shadow: 0 4px 10px rgba(0, 160, 227, 0.45);\n}\n\n/* Deixa o Ã­cone um pouco menor e bem centralizado */\n.chat-input__send-button svg,\n.chat-input__send-button i {\n  width: 18px;\n  height: 18px;\n}\n",
          "responseMode": "responseNodes"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.3,
      "position": [
        -4560,
        240
      ],
      "id": "71f4946e-50cc-4cb8-82df-c6a10e8eac5d",
      "name": "When chat message received",
      "webhookId": "d90fd405-b2e9-487b-b316-61bce6f6b61f"
    },
    {
      "parameters": {
        "jsCode": "// ==============================\n// 1. ENTRADAS BÃSICAS\n// ==============================\nconst pedido = $json.pedido_cliente;\nconst data = $json.data || [];\nconst query = $json.query || \"\";\n\n// diagnostico pode vir como \"diagnostico\" ou \"DiagnÃ³stico\"\nconst d = $json.DiagnÃ³stico || $json.diagnostico || {};\n\n// ==============================\n// 2. HELPERS GERAIS\n// ==============================\nfunction toArraySafe(val) {\n  if (val == null) return [];\n  if (Array.isArray(val)) return val;\n  if (typeof val === \"object\") return [JSON.stringify(val, null, 2)];\n  return [String(val)];\n}\n\nfunction toTextSafe(val, fallback = \"â€”\") {\n  if (val == null) return fallback;\n  if (typeof val === \"string\") return val;\n  if (typeof val === \"number\" || typeof val === \"boolean\") return String(val);\n  return JSON.stringify(val, null, 2);\n}\n\n// ==============================\n// 3. FORMATAÃ‡ÃƒO NUMÃ‰RICA POR CONTEXTO\n// ==============================\nfunction formatMoneyBr(num) {\n  if (num == null || isNaN(num)) return \"R$ 0,00\";\n  return (\n    \"R$ \" +\n    Number(num).toLocaleString(\"pt-BR\", {\n      minimumFractionDigits: 2,\n      maximumFractionDigits: 2,\n    })\n  );\n}\n\nfunction formatPercentBr(num) {\n  if (num == null || isNaN(num)) return \"0%\";\n  return (\n    Number(num).toLocaleString(\"pt-BR\", {\n      minimumFractionDigits: 2,\n      maximumFractionDigits: 2,\n    }) + \"%\"\n  );\n}\n\nfunction formatIntegerBr(num) {\n  if (num == null || isNaN(num)) return \"0\";\n  return Number(num).toLocaleString(\"pt-BR\", {\n    maximumFractionDigits: 0,\n  });\n}\n\n// decide como formatar de acordo com o nome do campo / contexto pai\nfunction formatNumberWithContext(chave, parentKey, value) {\n  const k = (chave || \"\").toLowerCase();\n  const p = (parentKey || \"\").toLowerCase();\n\n  // 1) VALOR MONETÃRIO\n  if (\n    k.includes(\"valor\") ||\n    k.includes(\"fatura\") ||\n    k.includes(\"faturado\") ||\n    k.includes(\"receita\") ||\n    p.includes(\"valor_faturado\") ||\n    p.includes(\"faturado\") ||\n    p.includes(\"faturas\")\n  ) {\n    return formatMoneyBr(value);\n  }\n\n  // 2) PERCENTUAL\n  if (\n    k.includes(\"percent\") ||\n    k.includes(\"perc\") ||\n    k.endsWith(\"_pct\") ||\n    k.endsWith(\"_percentual\") ||\n    k.includes(\"taxa\") ||\n    k.includes(\"indice\") ||\n    k.includes(\"Ã­ndice\")\n  ) {\n    return formatPercentBr(value);\n  }\n\n  // 3) CONSUMO / VOLUME (mÂ³)\n  if (\n    k.includes(\"consumo\") ||\n    k.includes(\"volume\") ||\n    k.includes(\"m3\") ||\n    k.includes(\"mÂ³\")\n  ) {\n    return `${formatIntegerBr(value)} mÂ³`;\n  }\n\n  // 4) LEITURAS / QUANTIDADES / REGISTROS (inteiro com milhar)\n  if (\n    k.includes(\"leitura\") ||\n    k.includes(\"leituras\") ||\n    k.includes(\"qtd\") ||\n    k.includes(\"quantidade\") ||\n    k.includes(\"total\") ||\n    k.includes(\"economias\") ||\n    k.includes(\"registros\")\n  ) {\n    return formatIntegerBr(value);\n  }\n\n  // 5) DEFAULT: nÃºmero \"cru\", mas em pt-BR\n  return Number(value).toLocaleString(\"pt-BR\", {\n    maximumFractionDigits: 2,\n  });\n}\n\n// ==============================\n// 4. AMOSTRA DE DADOS (JSON COMPLETO)\n// ==============================\nlet amostraDados;\nif (data.length === 0) {\n  amostraDados = \"Nenhum registro retornado.\";\n} else {\n  amostraDados = JSON.stringify(data, null, 2);\n}\n\n// ==============================\n// 5. ACESSO AOS BLOCOS DO DIAGNÃ“STICO\n// ==============================\nconst contexto =\n  d[\"ğŸ§­ contexto\"] ||\n  d[\"ğŸ§­ contexto_setorial\"] ||\n  d[\"contexto\"] ||\n  d[\"contexto_setorial\"] ||\n  \"â€”\";\n\nconst indicadoresRaw = d[\"ğŸ“ˆ indicadores\"] || d[\"indicadores\"] || \"â€”\";\n\nlet indicadoresDescricao = \"â€”\";\nlet valores = {};\n\nif (typeof indicadoresRaw === \"string\") {\n  indicadoresDescricao = indicadoresRaw;\n} else if (indicadoresRaw && typeof indicadoresRaw === \"object\") {\n  indicadoresDescricao = toTextSafe(\n    indicadoresRaw[\"ğŸ“ descriÃ§Ã£o\"] || indicadoresRaw[\"ğŸ“ descricao\"] || indicadoresRaw.descricao\n  );\n  valores =\n    indicadoresRaw[\"ğŸ”¢ valores\"] ||\n    indicadoresRaw[\"valores\"] ||\n    {};\n}\n\n// ==============================\n// 5.1 CAPTURA ROBUSTA DA ANÃLISE INTERPRETATIVA\n// ==============================\nfunction extrairAnaliseInterpretativa(...objs) {\n  for (const obj of objs) {\n    if (!obj || typeof obj !== \"object\") continue;\n    for (const [k, v] of Object.entries(obj)) {\n      const kl = k.toLowerCase();\n      if (\n        kl.includes(\"anÃ¡lise_interpretativa\") ||\n        kl.includes(\"analise_interpretativa\")\n      ) {\n        if (typeof v === \"string\") return v;\n      }\n    }\n  }\n  return \"-\";\n}\n\nconst analiseInterpretativa =\n  d[\"ğŸ“‹anÃ¡lise_interpretativa\"] ||\n  d[\"ğŸ“‹ anÃ¡lise_interpretativa\"] ||\n  extrairAnaliseInterpretativa(d, valores);\n\n// aÃ§Ãµes (lista simples)\nconst acoes = toArraySafe(d[\"âš™ï¸ aÃ§Ãµes\"] || d[\"acoes\"] || d[\"aÃ§Ãµes\"]);\n\n// descriÃ§Ã£o tÃ©cnica\nconst descricaoTecnica = toTextSafe(d[\"ğŸ§¾ descriÃ§Ã£o\"] || d[\"descricao\"]);\n\n// resumo consultivo\nconst resumoConsultivo = toTextSafe(\n  d[\"ğŸ§· resumo_consultivo\"] || d[\"resumo_consultivo\"]\n);\n\n// ==============================\n// 6. FORMATADOR GENÃ‰RICO DE \"ğŸ”¢ valores\"\n// ==============================\nfunction formatValores(obj, parentKey = \"\") {\n  if (obj == null) return \"â€”\";\n\n  // PRIMITIVO\n  if (\n    typeof obj === \"string\" ||\n    typeof obj === \"number\" ||\n    typeof obj === \"boolean\"\n  ) {\n    if (typeof obj === \"number\") {\n      return formatNumberWithContext(\"\", parentKey, obj);\n    }\n    return String(obj);\n  }\n\n  // ARRAY\n  if (Array.isArray(obj)) {\n    return obj\n      .map((item, idx) => {\n        if (item && typeof item === \"object\") {\n          const partes = [];\n          for (const [k, v] of Object.entries(item)) {\n            if (typeof v === \"number\") {\n              partes.push(\n                `${k}: ${formatNumberWithContext(k, parentKey, v)}`\n              );\n            } else {\n              partes.push(`${k}: ${toTextSafe(v)}`);\n            }\n          }\n          return `â€¢ item ${idx + 1}: ${partes.join(\" | \")}`;\n        }\n        if (typeof item === \"number\") {\n          return `â€¢ ${formatNumberWithContext(\"\", parentKey, item)}`;\n        }\n        return `â€¢ ${toTextSafe(item)}`;\n      })\n      .join(\"\\n\");\n  }\n\n  // OBJETO\n  if (typeof obj === \"object\") {\n    const linhas = [];\n\n    for (const [chave, val] of Object.entries(obj)) {\n      const chaveLower = chave.toLowerCase();\n\n      // nÃ£o renderizar anÃ¡lise_interpretativa dentro de valores\n      if (\n        chaveLower.includes(\"anÃ¡lise_interpretativa\") ||\n        chaveLower.includes(\"analise_interpretativa\")\n      ) {\n        continue;\n      }\n\n      // primitivo\n      if (\n        val == null ||\n        typeof val === \"string\" ||\n        typeof val === \"number\" ||\n        typeof val === \"boolean\"\n      ) {\n        if (typeof val === \"number\") {\n          linhas.push(\n            `- ${chave}: ${formatNumberWithContext(chave, parentKey, val)}`\n          );\n        } else {\n          linhas.push(`- ${chave}: ${toTextSafe(val)}`);\n        }\n        continue;\n      }\n\n      // array\n      if (Array.isArray(val)) {\n        if (\n          val.length > 0 &&\n          val.every(\n            (item) => item && typeof item === \"object\" && !Array.isArray(item)\n          )\n        ) {\n          const itensFormatados = val\n            .map((item) => {\n              const partes = [];\n\n              const categoria =\n                item.categoria ||\n                item.Categoria ||\n                item.tipo ||\n                item.Tipo ||\n                item.nome ||\n                item.Nome;\n              const rota = item.rota || item.Rota;\n              const bairro = item.bairro || item.Bairro;\n\n              if (rota != null) partes.push(`rota: ${rota}`);\n              if (bairro != null) partes.push(`bairro: ${bairro}`);\n              if (categoria != null) partes.push(`categoria: ${categoria}`);\n\n              for (const [k2, v2] of Object.entries(item)) {\n                if (\n                  k2 === \"categoria\" ||\n                  k2 === \"Categoria\" ||\n                  k2 === \"tipo\" ||\n                  k2 === \"Tipo\" ||\n                  k2 === \"nome\" ||\n                  k2 === \"Nome\" ||\n                  k2 === \"rota\" ||\n                  k2 === \"Rota\" ||\n                  k2 === \"bairro\" ||\n                  k2 === \"Bairro\"\n                ) {\n                  continue;\n                }\n\n                if (typeof v2 === \"number\") {\n                  partes.push(\n                    `${k2}: ${formatNumberWithContext(k2, chave, v2)}`\n                  );\n                } else {\n                  partes.push(`${k2}: ${toTextSafe(v2)}`);\n                }\n              }\n\n              return `  â€¢ ${partes.join(\" | \")}`;\n            })\n            .join(\"\\n\");\n\n          linhas.push(`${chave}:\\n${itensFormatados}`);\n        } else {\n          const itens = val\n            .map((v) =>\n              typeof v === \"number\"\n                ? `  â€¢ ${formatNumberWithContext(chave, parentKey, v)}`\n                : `  â€¢ ${toTextSafe(v)}`\n            )\n            .join(\"\\n\");\n          linhas.push(`${chave}:\\n${itens}`);\n        }\n\n        continue;\n      }\n\n      // objeto aninhado\n      const sub = formatValores(val, chave)\n        .split(\"\\n\")\n        .map((ln) => \"  \" + ln)\n        .join(\"\\n\");\n      linhas.push(`${chave}:\\n${sub}`);\n    }\n\n    return linhas.length ? linhas.join(\"\\n\") : toTextSafe(obj);\n  }\n\n  return toTextSafe(obj);\n}\n\n// ==============================\n// 7. TEXTO FINAL\n// ==============================\nconst texto =\n  `**ğŸ“Œ PEDIDO DO CLIENTE**\\n` +\n  `${pedido || \"â€”\"}\\n\\n` +\n  `**ğŸ“Š DADOS UTILIZADOS (amostra)**\\n\\n` +\n  `${amostraDados}\\n\\n` +\n  `**ğŸ§® QUERY SQL**\\n\\n` +\n  `${query || \"â€”\"}\\n\\n` +\n  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n` +\n  `**ğŸ” DIAGNÃ“STICO BILL**\\n` +\n  `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n` +\n  `**ğŸ§­ CONTEXTO**\\n\\n` +\n  `${toTextSafe(contexto)}\\n\\n` +\n  `**ğŸ“ˆ INDICADORES**\\n\\n` +\n  `${indicadoresDescricao}\\n\\n` +\n  `**ğŸ”¢ VALORES (detalhado)**\\n\\n` +\n  `${formatValores(valores, \"ğŸ”¢ valores\")}\\n\\n` +\n  `**ğŸ“‹ ANÃLISE INTERPRETATIVA**\\n\\n` +\n  `${toTextSafe(analiseInterpretativa)}\\n\\n` +\n  `**ğŸ§¾ DESCRIÃ‡ÃƒO TÃ‰CNICA**\\n\\n` +\n  `${descricaoTecnica}\\n\\n` +\n  `**âš™ï¸ AÃ‡Ã•ES**\\n\\n` +\n  `${\n    acoes.length\n      ? acoes.map((s) => \"- \" + s).join(\"\\n\")\n      : \"â€”\"\n  }\\n\\n` +\n  `**ğŸ§· RESUMO CONSULTIVO**\\n\\n` +\n  `${resumoConsultivo}`;\n\n// ==============================\n// 8. RETORNO PARA O CHAT\n// ==============================\nreturn [\n  {\n    json: {\n      resposta_chat: texto,\n    },\n  },\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        288
      ],
      "id": "4752328f-bb8f-4207-9696-abe441fc415b",
      "name": "Formatar visualizaÃ§Ã£o",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "message": "={{$json.resposta_chat}}",
        "waitUserReply": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chat",
      "typeVersion": 1,
      "position": [
        512,
        240
      ],
      "id": "6fb1ad11-2744-4aba-930d-27c5f20310e7",
      "name": "Respond to Chat"
    }
  ],
  "connections": {
    "Download file": {
      "main": [
        [
          {
            "node": "Extract data from file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if query exists": {
      "main": [
        [
          {
            "node": "Extrair query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensagem de query invÃ¡lida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract SQL query": {
      "main": [
        [
          {
            "node": "Check if query exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine schema data and chat input": {
      "main": [
        [
          {
            "node": "Gerador de Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract data from file": {
      "main": [
        [
          {
            "node": "Combine schema data and chat input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setar informaÃ§Ãµes de ParÃ¢metros": {
      "main": [
        [
          {
            "node": "Constantes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If1": {
      "main": [
        [
          {
            "node": "Executar query",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Mensagem de query Proibida",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Repassar dados": {
      "main": [
        [
          {
            "node": "Gerou algum erro ?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Unificar saidas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair query": {
      "main": [
        [
          {
            "node": "If1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem de query invÃ¡lida": {
      "main": [
        [
          {
            "node": "Repassar dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem de query Proibida": {
      "main": [
        [
          {
            "node": "Repassar dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Constantes": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Executar query": {
      "main": [
        [
          {
            "node": "Repassar dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar envelope de dados e solicitaÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Analista de Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Unificar Resultado": {
      "main": [
        [
          {
            "node": "Formatar visualizaÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerou algum erro ?": {
      "main": [
        [
          {
            "node": "Unificar saidas",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "Gerar envelope de dados e solicitaÃ§Ã£o",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerador de Query": {
      "main": [
        [
          {
            "node": "Extract SQL query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analista de Dados": {
      "main": [
        [
          {
            "node": "Formatar retorno GPT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model gerador de Query": {
      "ai_languageModel": [
        [
          {
            "node": "Gerador de Query",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Window Buffer Memory Analista de dados": {
      "ai_memory": [
        [
          {
            "node": "Analista de Dados",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model Analista de dados": {
      "ai_languageModel": [
        [
          {
            "node": "Analista de Dados",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "MemÃ³ria gerador de query": {
      "ai_memory": [
        [
          {
            "node": "Gerador de Query",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Unificar saidas": {
      "main": [
        [
          {
            "node": "Gerou algum erro ?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerou algum erro ?1": {
      "main": [
        [
          {
            "node": "Respond to Webhook1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Unificar Resultado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar retorno GPT": {
      "main": [
        [
          {
            "node": "Unificar saidas",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "When chat message received": {
      "main": [
        [
          {
            "node": "Setar informaÃ§Ãµes de ParÃ¢metros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar visualizaÃ§Ã£o": {
      "main": [
        [
          {
            "node": "Respond to Chat",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": null,
  "pinData": {},
  "versionId": "b463ca40-8cf8-48c8-b943-34ec4e498308",
  "triggerCount": 0,
  "shared": [
    {
      "updatedAt": "2025-11-18T14:34:56.618Z",
      "createdAt": "2025-11-18T14:34:56.618Z",
      "role": "workflow:owner",
      "workflowId": "uGSEvL7X7bMSBslR",
      "projectId": "bDUBly1zU3yziLIn"
    }
  ],
  "tags": []
}